{"version":3,"sources":["../src/obniz/libs/embeds/bleHci/protocol/peripheral/bindings.ts"],"names":[],"mappings":";AAAA;;;;GAIG;AACH,4CAA4C;;;;;AAI5C;;GAEG;AACH,MAAM,KAAK,GAAQ,GAAG,EAAE,GAAE,CAAC,CAAC;AAC5B,kEAAyC;AAGzC,8DAAqC;AACrC,gDAAwB;AACxB,kDAA0B;AAI1B;;GAEG;AACH,MAAM,aAAc,SAAQ,uBAAoC;IAU9D,YAAY,WAAgB;QAC1B,KAAK,EAAE,CAAC;QACR,IAAI,CAAC,MAAM,GAAG,IAAI,CAAC;QAEnB,IAAI,CAAC,YAAY,GAAG,KAAK,CAAC;QAE1B,IAAI,CAAC,IAAI,GAAG,WAAW,CAAC;QACxB,IAAI,CAAC,IAAI,GAAG,IAAI,aAAG,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;QAC/B,IAAI,CAAC,KAAK,GAAG,IAAI,cAAI,EAAE,CAAC;QAExB,IAAI,CAAC,QAAQ,GAAG,IAAI,CAAC;QACrB,IAAI,CAAC,OAAO,GAAG,IAAI,CAAC;QACpB,IAAI,CAAC,UAAU,GAAG,IAAI,CAAC;IACzB,CAAC;IAEM,KAAK,CAAC,oBAAoB,CAAC,IAAS,EAAE,YAAiB;QAC5D,IAAI,CAAC,YAAY,GAAG,IAAI,CAAC;QAEzB,MAAM,IAAI,CAAC,IAAI,CAAC,oBAAoB,CAAC,IAAI,EAAE,YAAY,CAAC,CAAC;IAC3D,CAAC;IAEM,KAAK,CAAC,2BAA2B,CAAC,IAAS;QAChD,IAAI,CAAC,YAAY,GAAG,IAAI,CAAC;QAEzB,MAAM,IAAI,CAAC,IAAI,CAAC,2BAA2B,CAAC,IAAI,CAAC,CAAC;IACpD,CAAC;IAEM,KAAK,CAAC,+BAA+B,CAAC,iBAAsB,EAAE,QAAa;QAChF,IAAI,CAAC,YAAY,GAAG,IAAI,CAAC;QAEzB,MAAM,IAAI,CAAC,IAAI,CAAC,+BAA+B,CAAC,iBAAiB,EAAE,QAAQ,CAAC,CAAC;IAC/E,CAAC;IAEM,KAAK,CAAC,mBAAmB;QAC9B,IAAI,CAAC,YAAY,GAAG,KAAK,CAAC;QAE1B,MAAM,IAAI,CAAC,IAAI,CAAC,mBAAmB,EAAE,CAAC;IACxC,CAAC;IAEM,KAAK,CAAC,WAAW,CAAC,QAAa;QACpC,IAAI,CAAC,KAAK,CAAC,WAAW,CAAC,QAAQ,CAAC,CAAC;IACnC,CAAC;IAEM,UAAU;QACf,IAAI,IAAI,CAAC,OAAO,EAAE;YAChB,KAAK,CAAC,sBAAsB,CAAC,CAAC;YAE9B,IAAI,CAAC,IAAI,CAAC,UAAU,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;SACpC;IACH,CAAC;IAEM,KAAK,CAAC,cAAc;QACzB,IAAI,IAAI,CAAC,OAAO,EAAE;YAChB,MAAM,IAAI,GAAG,MAAM,IAAI,CAAC,IAAI,CAAC,YAAY,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;YACxD,OAAO,IAAI,CAAC;SACb;QACD,OAAO,IAAI,CAAC;IACd,CAAC;IAEM,IAAI;QACT,IAAI,CAAC,KAAK,CAAC,EAAE,CAAC,WAAW,EAAE,IAAI,CAAC,WAAW,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,CAAC;QAExD,IAAI,CAAC,IAAI,CAAC,EAAE,CAAC,aAAa,EAAE,IAAI,CAAC,aAAa,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,CAAC;QAC3D,IAAI,CAAC,IAAI,CAAC,EAAE,CAAC,gBAAgB,EAAE,IAAI,CAAC,gBAAgB,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,CAAC;QACjE,IAAI,CAAC,IAAI,CAAC,EAAE,CAAC,sBAAsB,EAAE,IAAI,CAAC,sBAAsB,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,CAAC;QAE7E,IAAI,CAAC,IAAI,CAAC,EAAE,CAAC,iBAAiB,EAAE,IAAI,CAAC,qBAAqB,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,CAAC;QACvE,IAAI,CAAC,IAAI,CAAC,EAAE,CAAC,eAAe,EAAE,IAAI,CAAC,eAAe,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,CAAC;QAC/D,IAAI,CAAC,IAAI,CAAC,EAAE,CAAC,YAAY,EAAE,IAAI,CAAC,YAAY,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,CAAC;IAC3D,CAAC;IAEM,aAAa,CAAC,KAAU;QAC7B,IAAI,IAAI,CAAC,MAAM,KAAK,KAAK,EAAE;YACzB,OAAO;SACR;QACD,IAAI,CAAC,MAAM,GAAG,KAAK,CAAC;QAEpB,IAAI,KAAK,KAAK,cAAc,EAAE;YAC5B,OAAO,CAAC,GAAG,CAAC,4EAA4E,CAAC,CAAC;YAC1F,OAAO,CAAC,GAAG,CAAC,4EAA4E,CAAC,CAAC;YAC1F,OAAO,CAAC,GAAG,CAAC,wEAAwE,CAAC,CAAC;SACvF;aAAM,IAAI,KAAK,KAAK,aAAa,EAAE;YAClC,OAAO,CAAC,GAAG,CAAC,sFAAsF,CAAC,CAAC;YACpG,OAAO,CAAC,GAAG,CAAC,sDAAsD,CAAC,CAAC;YACpE,OAAO,CAAC,GAAG,CAAC,sDAAsD,CAAC,CAAC;SACrE;QAED,IAAI,CAAC,IAAI,CAAC,aAAa,EAAE,KAAK,CAAC,CAAC;IAClC,CAAC;IAEM,gBAAgB,CACrB,MAAW,EACX,MAAY,EACZ,IAAU,EACV,WAAiB,EACjB,OAAa,EACb,QAAc,EACd,OAAa,EACb,kBAAwB,EACxB,mBAAyB;QAEzB,IAAI,IAAI,KAAK,CAAC,EAAE;YACd,oBAAoB;YACpB,OAAO;SACR;QAED,IAAI,CAAC,QAAQ,GAAG,OAAO,CAAC;QACxB,IAAI,CAAC,OAAO,GAAG,MAAM,CAAC;QACtB,IAAI,CAAC,UAAU,GAAG,IAAI,oBAAS,CAAC,IAAI,CAAC,IAAI,EAAE,MAAM,EAAE,IAAI,CAAC,IAAI,CAAC,WAAW,EAAE,IAAI,CAAC,IAAI,CAAC,OAAO,EAAE,WAAW,EAAE,OAAO,CAAC,CAAC;QACnH,IAAI,CAAC,KAAK,CAAC,YAAY,CAAC,IAAI,CAAC,UAAU,CAAC,CAAC;QAEzC,IAAI,CAAC,IAAI,CAAC,QAAQ,EAAE,OAAO,CAAC,CAAC;IAC/B,CAAC;IAEM,sBAAsB,CAAC,MAAW,EAAE,QAAc,EAAE,OAAa,EAAE,kBAAwB;QAChG,QAAQ;IACV,CAAC;IAEM,KAAK,CAAC,qBAAqB,CAAC,MAAW,EAAE,MAAY;QAC1D,IAAI,IAAI,CAAC,OAAO,KAAK,MAAM,EAAE;YAC3B,OAAO,CAAC,iBAAiB;SAC1B;QACD,IAAI,IAAI,CAAC,UAAU,EAAE;YACnB,IAAI,CAAC,UAAU,CAAC,GAAG,EAAE,CAAC;SACvB;QAED,MAAM,OAAO,GAAQ,IAAI,CAAC,QAAQ,CAAC;QAEnC,IAAI,CAAC,QAAQ,GAAG,IAAI,CAAC;QACrB,IAAI,CAAC,OAAO,GAAG,IAAI,CAAC;QACpB,IAAI,CAAC,UAAU,GAAG,IAAI,CAAC;QAEvB,IAAI,OAAO,EAAE;YACX,IAAI,CAAC,IAAI,CAAC,YAAY,EAAE,OAAO,EAAE,MAAM,CAAC,CAAC,CAAC,mBAAmB;SAC9D;QAED,IAAI,IAAI,CAAC,YAAY,EAAE;YACrB,MAAM,IAAI,CAAC,IAAI,CAAC,sBAAsB,EAAE,CAAC;SAC1C;IACH,CAAC;IAEM,eAAe,CAAC,MAAW,EAAE,OAAa;QAC/C,IAAI,IAAI,CAAC,OAAO,KAAK,MAAM,IAAI,IAAI,CAAC,UAAU,EAAE;YAC9C,IAAI,CAAC,UAAU,CAAC,WAAW,CAAC,OAAO,CAAC,CAAC;SACtC;IACH,CAAC;IAEM,WAAW,CAAC,GAAQ;QACzB,IAAI,CAAC,IAAI,CAAC,WAAW,EAAE,GAAG,CAAC,CAAC;IAC9B,CAAC;IAEM,YAAY,CAAC,MAAc,EAAE,GAAS,EAAE,IAAU;QACvD,IAAI,IAAI,CAAC,OAAO,KAAK,MAAM,IAAI,IAAI,CAAC,UAAU,EAAE;YAC9C,IAAI,CAAC,UAAU,CAAC,IAAI,CAAC,GAAG,EAAE,IAAI,CAAC,CAAC;SACjC;IACH,CAAC;CACF;AAED,kBAAe,aAAa,CAAC","file":"bindings.js","sourcesContent":["/**\n * @packageDocumentation\n *\n * @ignore\n */\n// var debug = require('debug')('bindings');\n\nimport Hci from \"../hci\";\n\n/**\n * @ignore\n */\nconst debug: any = () => {};\nimport EventEmitter from \"eventemitter3\";\nimport os from \"os\";\nimport { Handle } from \"../../bleTypes\";\nimport AclStream from \"./acl-stream\";\nimport Gap from \"./gap\";\nimport Gatt from \"./gatt\";\n\ntype BlenoBindingsEventType = \"stateChange\" | \"mtuChange\" | \"accept\" | \"disconnect\";\n\n/**\n * @ignore\n */\nclass BlenoBindings extends EventEmitter<BlenoBindingsEventType> {\n  public _state: any;\n  public _advertising: any;\n  public _hci: Hci;\n  public _gap: Gap;\n  public _gatt: Gatt;\n  public _address: any;\n  public _handle: Handle | null;\n  private _aclStream: AclStream | null;\n\n  constructor(hciProtocol: any) {\n    super();\n    this._state = null;\n\n    this._advertising = false;\n\n    this._hci = hciProtocol;\n    this._gap = new Gap(this._hci);\n    this._gatt = new Gatt();\n\n    this._address = null;\n    this._handle = null;\n    this._aclStream = null;\n  }\n\n  public async startAdvertisingWait(name: any, serviceUuids: any) {\n    this._advertising = true;\n\n    await this._gap.startAdvertisingWait(name, serviceUuids);\n  }\n\n  public async startAdvertisingIBeaconWait(data: any) {\n    this._advertising = true;\n\n    await this._gap.startAdvertisingIBeaconWait(data);\n  }\n\n  public async startAdvertisingWithEIRDataWait(advertisementData: any, scanData: any) {\n    this._advertising = true;\n\n    await this._gap.startAdvertisingWithEIRDataWait(advertisementData, scanData);\n  }\n\n  public async stopAdvertisingWait() {\n    this._advertising = false;\n\n    await this._gap.stopAdvertisingWait();\n  }\n\n  public async setServices(services: any) {\n    this._gatt.setServices(services);\n  }\n\n  public disconnect() {\n    if (this._handle) {\n      debug(\"disconnect by server\");\n\n      this._hci.disconnect(this._handle);\n    }\n  }\n\n  public async updateRssiWait(): Promise<number | null> {\n    if (this._handle) {\n      const rssi = await this._hci.readRssiWait(this._handle);\n      return rssi;\n    }\n    return null;\n  }\n\n  public init() {\n    this._gatt.on(\"mtuChange\", this.onMtuChange.bind(this));\n\n    this._hci.on(\"stateChange\", this.onStateChange.bind(this));\n    this._hci.on(\"leConnComplete\", this.onLeConnComplete.bind(this));\n    this._hci.on(\"leConnUpdateComplete\", this.onLeConnUpdateComplete.bind(this));\n\n    this._hci.on(\"disconnComplete\", this.onDisconnCompleteWait.bind(this));\n    this._hci.on(\"encryptChange\", this.onEncryptChange.bind(this));\n    this._hci.on(\"aclDataPkt\", this.onAclDataPkt.bind(this));\n  }\n\n  public onStateChange(state: any) {\n    if (this._state === state) {\n      return;\n    }\n    this._state = state;\n\n    if (state === \"unauthorized\") {\n      console.log(\"bleno warning: adapter state unauthorized, please run as root or with sudo\");\n      console.log(\"               or see README for information on running without root/sudo:\");\n      console.log(\"               https://github.com/sandeepmistry/bleno#running-on-linux\");\n    } else if (state === \"unsupported\") {\n      console.log(\"bleno warning: adapter does not support Bluetooth Low Energy (BLE, Bluetooth Smart).\");\n      console.log(\"               Try to run with environment variable:\");\n      console.log(\"               [sudo] BLENO_HCI_DEVICE_ID=x node ...\");\n    }\n\n    this.emit(\"stateChange\", state);\n  }\n\n  public onLeConnComplete(\n    status: any,\n    handle?: any,\n    role?: any,\n    addressType?: any,\n    address?: any,\n    interval?: any,\n    latency?: any,\n    supervisionTimeout?: any,\n    masterClockAccuracy?: any,\n  ) {\n    if (role !== 1) {\n      // not slave, ignore\n      return;\n    }\n\n    this._address = address;\n    this._handle = handle;\n    this._aclStream = new AclStream(this._hci, handle, this._hci.addressType, this._hci.address, addressType, address);\n    this._gatt.setAclStream(this._aclStream);\n\n    this.emit(\"accept\", address);\n  }\n\n  public onLeConnUpdateComplete(handle: any, interval?: any, latency?: any, supervisionTimeout?: any) {\n    // no-op\n  }\n\n  public async onDisconnCompleteWait(handle: any, reason?: any) {\n    if (this._handle !== handle) {\n      return; // not peripheral\n    }\n    if (this._aclStream) {\n      this._aclStream.end();\n    }\n\n    const address: any = this._address;\n\n    this._address = null;\n    this._handle = null;\n    this._aclStream = null;\n\n    if (address) {\n      this.emit(\"disconnect\", address, reason); // TODO: use reason\n    }\n\n    if (this._advertising) {\n      await this._gap.restartAdvertisingWait();\n    }\n  }\n\n  public onEncryptChange(handle: any, encrypt?: any) {\n    if (this._handle === handle && this._aclStream) {\n      this._aclStream.pushEncrypt(encrypt);\n    }\n  }\n\n  public onMtuChange(mtu: any) {\n    this.emit(\"mtuChange\", mtu);\n  }\n\n  public onAclDataPkt(handle: Handle, cid?: any, data?: any) {\n    if (this._handle === handle && this._aclStream) {\n      this._aclStream.push(cid, data);\n    }\n  }\n}\n\nexport default BlenoBindings;\n"]}