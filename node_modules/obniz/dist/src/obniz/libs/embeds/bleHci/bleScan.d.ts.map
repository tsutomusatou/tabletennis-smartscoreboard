{"version":3,"sources":["../src/obniz/libs/embeds/bleHci/bleScan.ts"],"names":[],"mappings":"AAKA,OAAO,YAAY,MAAM,eAAe,CAAC;AAIzC,OAAO,QAAQ,MAAM,OAAO,CAAC;AAE7B,OAAO,mBAAmB,MAAM,uBAAuB,CAAC;AACxD,OAAO,EAAE,gBAAgB,EAAE,IAAI,EAAE,MAAM,YAAY,CAAC;AAEpD,oBAAY,WAAW,GAAG,SAAS,GAAG,QAAQ,CAAC;AAC/C,oBAAY,SAAS,GAAG,MAAM,EAAE,CAAC;AAEjC;;;;GAIG;AACH,MAAM,WAAW,aAAa;IAC5B;;;OAGG;IACH,KAAK,CAAC,EAAE,IAAI,EAAE,CAAC;IACf;;OAEG;IACH,SAAS,CAAC,EAAE,MAAM,EAAE,GAAG,MAAM,CAAC;IAE9B;;OAEG;IACH,eAAe,CAAC,EAAE,MAAM,GAAG,MAAM,EAAE,CAAC;IAEpC;;OAEG;IACH,aAAa,CAAC,EAAE,gBAAgB,EAAE,GAAG,gBAAgB,CAAC;IAEtD;;;;;;;OAOG;IACH,MAAM,CAAC,EAAE,SAAS,EAAE,GAAG,SAAS,CAAC;CAClC;AAED;;GAEG;AACH,MAAM,WAAW,+BAA+B;IAC9C,aAAa,CAAC,EAAE,gBAAgB,CAAC;IACjC,eAAe,CAAC,EAAE,MAAM,CAAC;IACzB,IAAI,CAAC,EAAE,IAAI,CAAC;IACZ,MAAM,CAAC,EAAE,MAAM,EAAE,CAAC;CACnB;AAED,MAAM,WAAW,cAAc;IAC7B;;;;OAIG;IACH,QAAQ,CAAC,EAAE,MAAM,GAAG,IAAI,CAAC;IAEzB;;;;OAIG;IACH,SAAS,CAAC,EAAE,OAAO,CAAC;IAEpB;;;;;;;OAOG;IACH,UAAU,CAAC,EAAE,OAAO,CAAC;IAErB;;;;;;;;;;;;;;;;;;;;;;;;;;;OA2BG;IACH,cAAc,CAAC,EAAE,OAAO,CAAC;CAC1B;AAED,aAAK,YAAY,GAAG,SAAS,GAAG,UAAU,GAAG,SAAS,GAAG,UAAU,CAAC;AAEpE;;GAEG;AACH,MAAM,CAAC,OAAO,OAAO,OAAO;IAC1B;;;;;;;;;;;;;;;;;;OAkBG;IACI,QAAQ,CAAC,EAAE,CAAC,WAAW,EAAE,mBAAmB,EAAE,EAAE,KAAK,CAAC,EAAE,KAAK,KAAK,IAAI,CAAC;IAE9E;;;;;;;;;;;;;OAaG;IACI,MAAM,CAAC,EAAE,CAAC,UAAU,EAAE,mBAAmB,KAAK,IAAI,CAAC;IACnD,KAAK,EAAE,YAAY,CAAc;IACxC,SAAS,CAAC,UAAU,EAAE,aAAa,CAAC;IACpC,SAAS,CAAC,YAAY,EAAE,cAAc,CAAC;IACvC,SAAS,CAAC,QAAQ,EAAE,QAAQ,CAAC;IAC7B,SAAS,CAAC,OAAO,EAAE,YAAY,CAAC,QAAQ,GAAG,UAAU,CAAC,CAAC;IACvD,SAAS,CAAC,iBAAiB,EAAE,mBAAmB,EAAE,CAAC;IACnD,OAAO,CAAC,aAAa,CAAC,CAAiB;IACvC,OAAO,CAAC,kBAAkB,CAGlB;gBAEI,QAAQ,EAAE,QAAQ;IAU9B;;;OAGG;IACI,KAAK,CAAC,MAAM,GAAE,aAAkB,EAAE,QAAQ,GAAE,cAAmB;IAStE;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;OAgCG;IACU,SAAS,CAAC,MAAM,GAAE,aAAkB,EAAE,QAAQ,GAAE,cAAmB;IA6ChF;;;;;;;;;;;;;;;;;OAiBG;IACU,YAAY,CAAC,MAAM,EAAE,aAAa,EAAE,QAAQ,GAAE,cAAmB,GAAG,OAAO,CAAC,mBAAmB,GAAG,IAAI,CAAC;IAuBpH;;;;;;;;;;;;;;;;;;;;;;;;;;OA0BG;IACU,YAAY,CAAC,MAAM,EAAE,aAAa,EAAE,QAAQ,EAAE,cAAc,GAAG,OAAO,CAAC,mBAAmB,EAAE,CAAC;IAa1G;;;OAGG;IACI,GAAG;IASV;;;;;;;;;;OAUG;IACU,OAAO;IASpB;;;;OAIG;IACI,gBAAgB,CAAC,UAAU,EAAE,MAAM,EAAE,MAAM,EAAE,GAAG;IAmCvD;;OAEG;IACI,wBAAwB;IAU/B,SAAS,CAAC,uBAAuB,CAAC,UAAU,EAAE,+BAA+B,EAAE;IAsE/E,SAAS,CAAC,aAAa,CAAC,CAAC,EAAE,GAAG,EAAE,CAAC,GAAG,CAAC,EAAE,GAAG,CAAC,EAAE;IAQ7C,SAAS,CAAC,wBAAwB,CAAC,UAAU,EAAE,aAAa;IAyC5D,SAAS,CAAC,QAAQ,CAAC,UAAU,EAAE,mBAAmB;IAuClD,SAAS,CAAC,iBAAiB;IAO3B,OAAO,CAAC,MAAM;IAWd,OAAO,CAAC,aAAa;IAcrB,OAAO,CAAC,iBAAiB;IAazB,OAAO,CAAC,uBAAuB;IAa/B,OAAO,CAAC,cAAc;IAStB,OAAO,CAAC,YAAY;IAepB,OAAO,CAAC,qBAAqB;IAU7B,OAAO,CAAC,sBAAsB;IAO9B,OAAO,CAAC,uBAAuB;CAShC","file":"bleScan.d.ts","sourcesContent":["/**\n * @packageDocumentation\n * @module ObnizCore.Components.Ble.Hci\n */\nimport { rejects } from \"assert\";\nimport EventEmitter from \"eventemitter3\";\nimport semver from \"semver\";\nimport { ObnizOfflineError } from \"../../../ObnizError\";\nimport Util from \"../../utils/util\";\nimport ObnizBLE from \"./ble\";\nimport BleHelper from \"./bleHelper\";\nimport BleRemotePeripheral from \"./bleRemotePeripheral\";\nimport { BleDeviceAddress, UUID } from \"./bleTypes\";\n\nexport type BleScanMode = \"passive\" | \"active\";\nexport type BleBinary = number[];\n\n/**\n * All parameters are OR. If you set uuid and localName, obniz find uuid match but localName not match device.\n *\n * If you set BleScanSetting.filterOnDevice 'true', filters are apply on obniz device. So it reduce traffic.\n */\nexport interface BleScanTarget {\n  /**\n   * Service UUID for scan. Provide.\n   * Attention: iBeacon uuid is not service uuid. If you want to filter iBeacon. use binary filter\n   */\n  uuids?: UUID[];\n  /**\n   * scan target device localName. This need perfect matching.\n   */\n  localName?: string[] | string;\n\n  /**\n   * scan target device localName. This need prefix matching.\n   */\n  localNamePrefix?: string | string[];\n\n  /**\n   * device address\n   */\n  deviceAddress?: BleDeviceAddress[] | BleDeviceAddress;\n\n  /**\n   * Advanced search.\n   *\n   * You need to enable `filterOnDevice:true` to use this filter.\n   *\n   * Search partially matches advertisement / scan response regarding provided byte array.\n   * If advertisement / scan reponse has a matched byte array in the data, then passed.\n   */\n  binary?: BleBinary[] | BleBinary;\n}\n\n/**\n * @ignore\n */\nexport interface BleScanAdvertisementFilterParam {\n  deviceAddress?: BleDeviceAddress;\n  localNamePrefix?: string;\n  uuid?: UUID;\n  binary?: number[];\n}\n\nexport interface BleScanSetting {\n  /**\n   * Timeout seconds of scanning. Default is 30 seconds.\n   *\n   * If set null, scan don't stop automatically.\n   */\n  duration?: number | null;\n\n  /**\n   * (obnizOS 3 or later only)\n   *\n   * Specifying onfind will be called or not when an advertisement received from already known peripheral. Default is false : never called again.\n   */\n  duplicate?: boolean;\n\n  /**\n   * (obnizOS 3 or later only)\n   *\n   * Active scan or Passive Scan\n   *\n   * Default is true : activeScan.\n   *\n   */\n  activeScan?: boolean;\n\n  /**\n   * (obnizOS >= 3.2.0 only)\n   *\n   * filters are apply on obniz device\n   *\n   * True: filter on device and JavaScript.<br/>\n   * False : filter on JavaScript only.\n   *\n   * Default is false : filter on JavaScript only.\n   *\n   *\n   * ```javascript\n   * // Javascript Example\n   * var target = {\n   *     localName: \"obniz-BLE\",     //scan only has localName \"obniz-BLE\"\n   * };\n   *\n   * var setting = {\n   *    duration : 10,  //scan duration time in seconds. default is 30 sec.\n   *    filterOnDevice: true\n   * }\n   *\n   * await obniz.ble.initWait();\n   * await obniz.ble.scan.startWait(target, setting);\n   * ```\n   *\n   *\n   */\n  filterOnDevice?: boolean;\n}\n\ntype BleScanState = \"stopped\" | \"stopping\" | \"started\" | \"starting\";\n\n/**\n * @category Use as Central\n */\nexport default class BleScan {\n  /**\n   * This function gets called when obniz Board finishes scanning.\n   *\n   * ```javascript\n   * // Javascript Example\n   *\n   * obniz.ble.scan.onfind = function(peripheral){\n   *   console.log(peripheral)\n   * };\n   *\n   * obniz.ble.scan.onfinish = function(peripherals){\n   *    console.log(\"scan timeout!\")\n   * };\n   *\n   * await obniz.ble.initWait();\n   * await obniz.ble.scan.startWait();\n   * ```\n   *\n   */\n  public onfinish?: (peripherals: BleRemotePeripheral[], error?: Error) => void;\n\n  /**\n   * This function gets called when obniz Board finds a new peripheral.\n   *\n   * ```javascript\n   * // Javascript Example\n   *\n   * obniz.ble.scan.onfind = function(peripheral){\n   *  console.log(peripheral)\n   * };\n   *\n   * await obniz.ble.initWait();\n   * await obniz.ble.scan.startWait();\n   * ```\n   */\n  public onfind?: (peripheral: BleRemotePeripheral) => void;\n  public state: BleScanState = \"stopping\";\n  protected scanTarget: BleScanTarget;\n  protected scanSettings: BleScanSetting;\n  protected obnizBle: ObnizBLE;\n  protected emitter: EventEmitter<\"onfind\" | \"onfinish\">;\n  protected scanedPeripherals: BleRemotePeripheral[];\n  private _timeoutTimer?: NodeJS.Timeout;\n  private _delayNotifyTimers: Array<{\n    peripheral: BleRemotePeripheral;\n    timer: NodeJS.Timeout;\n  }> = [];\n\n  constructor(obnizBle: ObnizBLE) {\n    this.scanTarget = {};\n    this.scanSettings = {};\n    this.obnizBle = obnizBle;\n    this.emitter = new EventEmitter();\n\n    this.scanedPeripherals = [];\n    this._timeoutTimer = undefined;\n  }\n\n  /**\n   * Use startWait() instead.\n   * @deprecated\n   */\n  public start(target: BleScanTarget = {}, settings: BleScanSetting = {}) {\n    console.log(`start() is deprecated since 3.5.0. Use startWait() instead`);\n    this.startWait(target, settings)\n      .then(() => {})\n      .catch((e) => {\n        throw e;\n      });\n  }\n\n  /**\n   * This starts scanning BLE.\n   *\n   * You can filter uuids or localName using the target param.\n   *\n   * ```javascript\n   * // Javascript Example\n   * var target = {\n   *     uuids: [\"fff0\",\"FFF1\"],     //scan only has uuids \"fff0\" and \"FFF1\"\n   *     localName: \"obniz-BLE\",     //scan only has localName \"obniz-BLE\"\n   * };\n   *\n   * var setting = {\n   *    duration : 10  //scan duration time in seconds. default is 30 sec.\n   * }\n   *\n   * await obniz.ble.initWait();\n   * await obniz.ble.scan.startWait(target, setting);\n   * ```\n   *\n   * This is also possible without params being valid.\n   *\n   * ```javascript\n   * // Javascript Example\n   * await obniz.ble.scan.startWait();\n   * ```\n   *\n   * Scanning starts with no error and results with not advertisement found while a device is trying to connect a peripheral.\n   * Before start scannnig. Establishing connection must be completed or canceled.\n   *\n   * @param target\n   * @param settings\n   */\n  public async startWait(target: BleScanTarget = {}, settings: BleScanSetting = {}) {\n    this.obnizBle.warningIfNotInitialize();\n    this.state = \"starting\";\n\n    const timeout: number | null = settings.duration === undefined ? 30 : settings.duration;\n    settings.duplicate = !!settings.duplicate;\n    settings.filterOnDevice = !!settings.filterOnDevice;\n    settings.activeScan = settings.activeScan !== false;\n    this.scanSettings = settings;\n\n    target = target || {};\n    this.scanTarget.binary = target.binary;\n    this.scanTarget.deviceAddress = target.deviceAddress;\n    this.scanTarget.localName = target.localName;\n    this.scanTarget.localNamePrefix = target.localNamePrefix;\n    this.scanTarget.uuids = [];\n    if (target && target.uuids) {\n      this.scanTarget.uuids = target.uuids.map((elm: UUID) => {\n        return BleHelper.uuidFilter(elm);\n      });\n    }\n    this.scanedPeripherals = [];\n    this._clearDelayNotifyTimer();\n    if (settings.filterOnDevice) {\n      this._setTargetFilterOnDevice(this.scanTarget);\n    } else {\n      this._setTargetFilterOnDevice({}); // clear\n    }\n    await this.obnizBle.centralBindings.startScanningWait(null, false, settings.activeScan);\n\n    this.clearTimeoutTimer();\n    if (timeout !== null) {\n      this._timeoutTimer = setTimeout(async () => {\n        this._timeoutTimer = undefined;\n        try {\n          await this.endWait();\n        } catch (e) {\n          this.finish(e);\n        }\n      }, timeout * 1000);\n    }\n\n    this.state = \"started\";\n  }\n\n  /**\n   * This scans and returns the first peripheral that was found among the objects specified in the target.\n   *\n   * ```javascript\n   * // Javascript Example\n   *\n   * await obniz.ble.initWait();\n   * var target = {\n   *   uuids: [\"fff0\"],\n   * };\n   *\n   * var peripheral = await obniz.ble.scan.startOneWait(target);\n   * console.log(peripheral);\n   * ```\n   *\n   * @param target\n   * @param settings\n   */\n  public async startOneWait(target: BleScanTarget, settings: BleScanSetting = {}): Promise<BleRemotePeripheral | null> {\n    await this.startWait(target, settings);\n\n    return new Promise((resolve: any, reject: any) => {\n      this.emitter.once(\"onfind\", async (peripheral: BleRemotePeripheral, error: any) => {\n        if (error) {\n          rejects(error);\n          return;\n        }\n        resolve(peripheral);\n        await this.endWait();\n      });\n\n      this.emitter.once(\"onfinish\", (peripherals: BleRemotePeripheral[], error: any) => {\n        if (error) {\n          rejects(error);\n          return;\n        }\n        resolve(null);\n      });\n    });\n  }\n\n  /**\n   * This scans and returns all the peripherals found.\n   *\n   * This function does not return until scanning gets timed out.(default 30sec)\n   * If you want to change the default duration, you can do so with the duration param.\n   *\n   * ```javascript\n   * // Javascript Example\n   *\n   * await obniz.ble.initWait();\n   * var target = {\n   *  uuids: [\"fff0\"],\n   * };\n   * var setting = {\n   *   duration : 10\n   * }\n   *\n   * var peripherals = await obniz.ble.scan.startAllWait(target,setting);\n   *\n   * for(var peripheral of peripherals){\n   *   console.log(peripheral);\n   * }\n   * ```\n   *\n   * @param target\n   * @param settings\n   */\n  public async startAllWait(target: BleScanTarget, settings: BleScanSetting): Promise<BleRemotePeripheral[]> {\n    await this.startWait(target, settings);\n    return new Promise((resolve: any, reject: any) => {\n      this.emitter.once(\"onfinish\", (peripherals: BleRemotePeripheral, error: any) => {\n        if (error) {\n          reject(error);\n          return;\n        }\n        resolve(this.scanedPeripherals);\n      });\n    });\n  }\n\n  /**\n   * Use endWait() instead\n   * @deprecated\n   */\n  public end() {\n    console.log(`end() is deprecated since 3.5.0. Use endWait() instead`);\n    this.endWait()\n      .then(() => {})\n      .catch((e) => {\n        throw e;\n      });\n  }\n\n  /**\n   * This stops scanning BLE.\n   *\n   * ```javascript\n   * // Javascript Example\n   * await obniz.ble.initWait();\n   * await obniz.ble.scan.startWait();\n   * await obniz.wait(5000);\n   * await obniz.ble.scan.endWait();\n   * ```\n   */\n  public async endWait() {\n    if (this.state === \"started\" || this.state === \"starting\") {\n      this.state = \"stopping\";\n      this.clearTimeoutTimer();\n      await this.obnizBle.centralBindings.stopScanningWait();\n      this.finish();\n    }\n  }\n\n  /**\n   * @ignore\n   * @param notifyName\n   * @param params\n   */\n  public notifyFromServer(notifyName: string, params: any) {\n    switch (notifyName) {\n      case \"obnizClose\": {\n        this.finish(new ObnizOfflineError());\n        break;\n      }\n      case \"onfind\": {\n        const peripheral: BleRemotePeripheral = params;\n\n        const alreadyGotCompleteAdveData =\n          peripheral.adv_data &&\n          peripheral.adv_data.length > 0 &&\n          peripheral.scan_resp &&\n          peripheral.scan_resp.length > 0;\n        const nonConnectable = peripheral.ble_event_type === \"non_connectable_advertising\";\n        const maybeAdvOnly =\n          this._delayNotifyTimers.find((e) => e.peripheral.address === peripheral.address) &&\n          (!peripheral.scan_resp || peripheral.scan_resp.length === 0);\n\n        // wait for adv_data + scan resp\n        // 10 seconds timeout\n        if (alreadyGotCompleteAdveData || nonConnectable || maybeAdvOnly) {\n          this._removeDelayNotifyTimer(peripheral.address);\n          this._notifyOnFind(peripheral);\n        } else {\n          const timer = setInterval(() => {\n            this._notifyOnFind(peripheral);\n          }, 10000);\n          this._delayNotifyTimers.push({ timer, peripheral });\n        }\n        break;\n      }\n    }\n  }\n\n  /**\n   * Clear advertisement filter.\n   */\n  public clearAdvertisementFilter() {\n    this.obnizBle.Obniz.send({\n      ble: {\n        hci: {\n          advertisement_filter: [],\n        },\n      },\n    });\n  }\n\n  protected _setAdvertisementFilter(filterVals: BleScanAdvertisementFilterParam[]) {\n    // < 3.2.0\n    if (semver.lt(this.obnizBle.Obniz.firmware_ver!, \"3.2.0\")) {\n      return;\n    }\n\n    // #define BLE_AD_REPORT_DEVICE_ADDRESS_INDEX 2\n    // #define BLE_AD_REPORT_ADVERTISMENT_INDEX 9\n\n    const filters: any = [];\n    filterVals.forEach((filterVal: BleScanAdvertisementFilterParam) => {\n      if (filterVal.localNamePrefix) {\n        filters.push({\n          range: {\n            index: 9,\n            length: 255,\n          },\n          value: [0x08, ...Util.string2dataArray(filterVal.localNamePrefix)],\n        });\n        filters.push({\n          range: {\n            index: 9,\n            length: 255,\n          },\n          value: [0x09, ...Util.string2dataArray(filterVal.localNamePrefix)],\n        });\n      }\n\n      if (filterVal.deviceAddress) {\n        filters.push({\n          range: {\n            index: 2,\n            length: 6,\n          },\n          value: Util.hexToBinary(filterVal.deviceAddress, true),\n        });\n      }\n\n      if (filterVal.uuid) {\n        const binary = Util.hexToBinary(filterVal.uuid, true);\n\n        filters.push({\n          range: {\n            index: 9,\n            length: 255,\n          },\n          value: binary,\n        });\n      }\n\n      if (filterVal.binary) {\n        filters.push({\n          range: {\n            index: 0,\n            length: 255,\n          },\n          value: filterVal.binary,\n        });\n      }\n    });\n\n    this.obnizBle.Obniz.send({\n      ble: {\n        hci: {\n          advertisement_filter: filters,\n        },\n      },\n    });\n  }\n\n  protected _arrayWrapper<T>(val: T | T[]): T[] {\n    if (Array.isArray(val)) {\n      return val;\n    } else {\n      return [val];\n    }\n  }\n\n  protected _setTargetFilterOnDevice(scanTarget: BleScanTarget) {\n    // < 3.2.0\n    if (semver.lt(this.obnizBle.Obniz.firmware_ver!, \"3.2.0\")) {\n      return;\n    }\n\n    const adFilters: BleScanAdvertisementFilterParam[] = [];\n    if (scanTarget.uuids) {\n      scanTarget.uuids.map((elm: UUID) => {\n        adFilters.push({ uuid: BleHelper.uuidFilter(elm) });\n      });\n    }\n    if (scanTarget.localName) {\n      this._arrayWrapper(scanTarget.localName).forEach((name) => {\n        adFilters.push({ localNamePrefix: name });\n      });\n    }\n\n    if (scanTarget.deviceAddress) {\n      this._arrayWrapper(scanTarget.deviceAddress).forEach((address) => {\n        adFilters.push({ deviceAddress: address });\n      });\n    }\n\n    if (scanTarget.localNamePrefix) {\n      this._arrayWrapper(scanTarget.localNamePrefix).forEach((name) => {\n        adFilters.push({ localNamePrefix: name });\n      });\n    }\n    if (scanTarget.binary) {\n      if (Array.isArray(scanTarget.binary)) {\n        scanTarget.binary.forEach((e: any) => {\n          adFilters.push({ binary: e });\n        });\n      } else {\n        adFilters.push({ binary: scanTarget.binary as number[] });\n      }\n    }\n    this._setAdvertisementFilter(adFilters);\n  }\n\n  protected isTarget(peripheral: BleRemotePeripheral) {\n    const functionBinding = {\n      localNamePrefix: this.isLocalNamePrefixTarget.bind(this),\n      localName: this.isLocalNameTarget.bind(this),\n      uuids: this.isUuidTarget.bind(this),\n      deviceAddress: this.isDeviceAddressTarget.bind(this),\n      binary: this.isBinaryTarget.bind(this),\n    };\n\n    if (!this.scanTarget) {\n      // no filter\n      return true;\n    }\n\n    let noFilter = true;\n    // no filter\n    for (const key in functionBinding) {\n      const oneTarget: any = (this.scanTarget as any)[key] as any;\n      if (oneTarget) {\n        if (Array.isArray(oneTarget) && oneTarget.length > 0) {\n          noFilter = false;\n        } else if (!Array.isArray(oneTarget) && oneTarget) {\n          noFilter = false;\n        }\n      }\n    }\n    if (noFilter) {\n      return true;\n    }\n\n    let isTarget = false;\n    for (const key in functionBinding) {\n      const targetDetectFunc = (functionBinding as any)[key];\n      isTarget = isTarget || targetDetectFunc(peripheral);\n    }\n\n    return isTarget;\n  }\n\n  protected clearTimeoutTimer() {\n    if (this._timeoutTimer) {\n      clearTimeout(this._timeoutTimer);\n      this._timeoutTimer = undefined;\n    }\n  }\n\n  private finish(error?: Error) {\n    if (this.state !== \"stopped\") {\n      this.clearTimeoutTimer();\n      this._delayNotifyTimers.forEach((e) => this._notifyOnFind(e.peripheral));\n      this._clearDelayNotifyTimer();\n      this.state = \"stopped\";\n      this.obnizBle.Obniz._runUserCreatedFunction(this.onfinish, this.scanedPeripherals, error);\n      this.emitter.emit(\"onfinish\", this.scanedPeripherals, error);\n    }\n  }\n\n  private _notifyOnFind(peripheral: BleRemotePeripheral) {\n    if (this.scanSettings.duplicate === false) {\n      // duplicate filter\n      if (this.scanedPeripherals.find((e: any) => e.address === peripheral.address)) {\n        return;\n      }\n    }\n    if (this.isTarget(peripheral)) {\n      this.scanedPeripherals.push(peripheral);\n      this.obnizBle.Obniz._runUserCreatedFunction(this.onfind, peripheral);\n      this.emitter.emit(\"onfind\", peripheral);\n    }\n  }\n\n  private isLocalNameTarget(peripheral: BleRemotePeripheral) {\n    if (!this.scanTarget.localName) {\n      return false;\n    }\n    for (const name of this._arrayWrapper(this.scanTarget.localName)) {\n      if (name === peripheral.localName) {\n        return true;\n      }\n    }\n\n    return false;\n  }\n\n  private isLocalNamePrefixTarget(peripheral: BleRemotePeripheral) {\n    if (!this.scanTarget.localNamePrefix) {\n      return false;\n    }\n    for (const name of this._arrayWrapper(this.scanTarget.localNamePrefix)) {\n      if (peripheral.localName && peripheral.localName.startsWith(name)) {\n        return true;\n      }\n    }\n\n    return false;\n  }\n\n  private isBinaryTarget(peripheral: BleRemotePeripheral) {\n    if (!this.scanTarget.binary) {\n      return false;\n    }\n    return true; // cannot detect on obnizjs\n\n    return false;\n  }\n\n  private isUuidTarget(peripheral: BleRemotePeripheral) {\n    if (!this.scanTarget.uuids || this.scanTarget.uuids.length === 0) {\n      return false;\n    }\n    const uuids: any = peripheral.advertisementServiceUuids().map((e: any) => {\n      return BleHelper.uuidFilter(e);\n    });\n    for (const uuid of this.scanTarget.uuids) {\n      if (uuids.includes(uuid)) {\n        return true;\n      }\n    }\n    return false;\n  }\n\n  private isDeviceAddressTarget(peripheral: BleRemotePeripheral) {\n    if (!this.scanTarget.deviceAddress) {\n      return false;\n    }\n    if (this.scanTarget.deviceAddress === peripheral.address) {\n      return true;\n    }\n    return false;\n  }\n\n  private _clearDelayNotifyTimer() {\n    this._delayNotifyTimers.forEach((e) => {\n      clearTimeout(e.timer);\n    });\n    this._delayNotifyTimers = [];\n  }\n\n  private _removeDelayNotifyTimer(targetAddress: BleDeviceAddress) {\n    this._delayNotifyTimers = this._delayNotifyTimers.filter((e) => {\n      if (e.peripheral.address === targetAddress) {\n        clearTimeout(e.timer);\n        return false;\n      }\n      return true;\n    });\n  }\n}\n"]}