{"version":3,"sources":["../src/obniz/libs/embeds/bleHci/ble.ts"],"names":[],"mappings":"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","file":"ble.d.ts","sourcesContent":["/**\n * Obniz BLE are switches automatically. <br/>\n * obnizOS ver >= 3.0.0  : [[ObnizCore.Components.Ble.Hci | Hci]] <br/>\n * obnizOS ver < 3.0.0   : Not Supported <br/>\n * @packageDocumentation\n * @module ObnizCore.Components.Ble.Hci\n */\n\nimport ObnizBLEHci from \"./hci\";\nimport CentralBindings from \"./protocol/central/bindings\";\nimport HciProtocol from \"./protocol/hci\";\nimport PeripheralBindings from \"./protocol/peripheral/bindings\";\n\nimport semver from \"semver\";\nimport Obniz from \"../../../index\";\nimport {\n  ObnizBleHciStateError,\n  ObnizBleUnsupportedHciError,\n  ObnizBleUnSupportedOSVersionError,\n  ObnizOfflineError,\n} from \"../../../ObnizError\";\nimport { ComponentAbstract } from \"../../ComponentAbstact\";\nimport BleAdvertisement from \"./bleAdvertisement\";\nimport BleCharacteristic from \"./bleCharacteristic\";\nimport BleDescriptor from \"./bleDescriptor\";\nimport BlePeripheral from \"./blePeripheral\";\nimport BleRemotePeripheral from \"./bleRemotePeripheral\";\nimport BleScan from \"./bleScan\";\nimport BleSecurity from \"./bleSecurity\";\nimport BleService from \"./bleService\";\nimport { BleDeviceAddress, BleDeviceAddressType, UUID } from \"./bleTypes\";\n\n/**\n * Use a obniz device as a BLE device.\n * Peripheral and Central mode are supported\n */\nexport default class ObnizBLE extends ComponentAbstract {\n  /**\n   * @ignore\n   *\n   * @param data\n   * @param reverse\n   * @private\n   */\n  public static _dataArray2uuidHex(data: number[], reverse: boolean): UUID {\n    let uuid: any = [];\n    for (let i = 0; i < data.length; i++) {\n      uuid.push((\"00\" + data[i].toString(16).toLowerCase()).slice(-2));\n    }\n    if (reverse) {\n      uuid = uuid.reverse();\n    }\n    let str: any = uuid.join(\"\");\n    if (uuid.length >= 16) {\n      str =\n        str.slice(0, 8) +\n        \"-\" +\n        str.slice(8, 12) +\n        \"-\" +\n        str.slice(12, 16) +\n        \"-\" +\n        str.slice(16, 20) +\n        \"-\" +\n        str.slice(20);\n    }\n    return str;\n  }\n\n  public hci: ObnizBLEHci;\n  public peripheral!: BlePeripheral;\n  public scan!: BleScan;\n  public security!: BleSecurity;\n\n  /**\n   * @ignore\n   */\n  public centralBindings!: CentralBindings;\n\n  /**\n   * @ignore\n   */\n  public peripheralBindings!: PeripheralBindings;\n  public service: typeof BleService;\n  public characteristic: typeof BleCharacteristic;\n  public descriptor: typeof BleDescriptor;\n\n  /**\n   * @ignore\n   */\n  public advertisement!: BleAdvertisement;\n  protected hciProtocol!: HciProtocol;\n  protected _initialized!: boolean;\n  protected _initializeWarning!: boolean;\n  protected remotePeripherals!: BleRemotePeripheral[];\n\n  constructor(obniz: Obniz) {\n    super(obniz);\n    this.hci = new ObnizBLEHci(obniz);\n    this.service = BleService;\n    this.characteristic = BleCharacteristic;\n    this.descriptor = BleDescriptor;\n\n    this.on(\"/response/ble/hci/read\", (obj) => {\n      if (obj.hci) {\n        this.hci.notified(obj.hci);\n      }\n    });\n\n    obniz.on(\"close\", () => {\n      this._reset();\n    });\n\n    this._reset();\n  }\n  public debugHandler: any = () => {};\n\n  /**\n   * Initialize BLE module. You need call this first everything before.\n   * This throws if device is not supported device.\n   *\n   * ```javascript\n   * // Javascript Example\n   * await obniz.ble.initWait();\n   * ```\n   */\n  public async initWait(): Promise<void> {\n    if (!this._initialized) {\n      const MinHCIAvailableOS = \"3.0.0\";\n      if (semver.lt(this.Obniz.firmware_ver!, MinHCIAvailableOS)) {\n        throw new ObnizBleUnSupportedOSVersionError(this.Obniz.firmware_ver!, MinHCIAvailableOS);\n      }\n\n      this._initialized = true;\n\n      // force initialize on obnizOS < 3.2.0\n      if (semver.lt(this.Obniz.firmware_ver!, \"3.2.0\")) {\n        this.hci.init();\n        this.hci.end(); // disable once\n        this.hci.init();\n      }\n\n      try {\n        await this.hciProtocol.initWait();\n      } catch (e) {\n        if (e instanceof ObnizBleUnsupportedHciError) {\n          this.Obniz.reboot();\n        }\n        throw e;\n      }\n    }\n  }\n\n  /**\n   * @ignore\n   * @private\n   */\n  public _reset() {\n    if (this.peripheral && this.peripheral.currentConnectedDeviceAddress) {\n      const address = this.peripheral.currentConnectedDeviceAddress;\n      this.peripheral.currentConnectedDeviceAddress = null;\n      setTimeout(() => {\n        if (this.peripheral.onconnectionupdates) {\n          this.peripheral.onconnectionupdates({\n            address,\n            status: \"disconnected\",\n            reason: new ObnizOfflineError(),\n          });\n        }\n      }, 0);\n    }\n\n    if (this.remotePeripherals) {\n      for (const p of this.remotePeripherals) {\n        if (p.connected) {\n          p.notifyFromServer(\"statusupdate\", { status: \"disconnected\", reason: new ObnizOfflineError() });\n        }\n      }\n    }\n    if (this.scan && this.scan.state !== \"stopped\") {\n      this.scan.notifyFromServer(\"obnizClose\", {});\n    }\n    this.hci._reset();\n    this.hciProtocol = new HciProtocol(this.hci);\n    this.hciProtocol.debugHandler = (text: any) => {\n      this.debug(`BLE-HCI: ${text}`);\n    };\n    this.centralBindings = new CentralBindings(this.hciProtocol);\n    this.peripheralBindings = new PeripheralBindings(this.hciProtocol);\n    this.centralBindings.init();\n    this.peripheralBindings.init();\n    this.centralBindings.debugHandler = (text: any) => {\n      this.debug(`BLE: ${text}`);\n    };\n\n    this._initialized = false;\n    this._initializeWarning = true;\n\n    this.remotePeripherals = [];\n\n    this.peripheral = new BlePeripheral(this);\n\n    this.advertisement = new BleAdvertisement(this);\n    this.scan = new BleScan(this);\n    this.security = new BleSecurity(this);\n\n    this._bind();\n  }\n\n  /**\n   * Connect to peripheral without scanning.\n   * Returns a peripheral instance, but the advertisement information such as localName is null because it has not been scanned.\n   *\n   * ```javascript\n   * // Javascript Example\n   *\n   * await obniz.ble.initWait();\n   * var peripheral = obniz.ble.directConnect(\"e4b9efb29218\",\"random\");\n   * peripheral.onconnect = ()=>{\n   *   console.log(\"connected\");\n   * }\n   * ```\n   *\n   * @param uuid peripheral device address\n   * @param addressType \"random\" or \"public\"\n   */\n  public directConnect(uuid: UUID, addressType: BleDeviceAddressType) {\n    let peripheral: any = this.findPeripheral(uuid);\n    if (!peripheral) {\n      peripheral = new BleRemotePeripheral(this, uuid);\n      this.remotePeripherals.push(peripheral);\n    }\n    this.centralBindings.addPeripheralData(uuid, addressType);\n    peripheral.connect();\n    return peripheral;\n  }\n\n  /**\n   * Connect to peripheral without scanning, and wait to finish connecting.\n   *\n   * It throws when connection establish failed.\n   * Returns a peripheral instance, but the advertisement information such as localName is null because it has not been scanned.\n   *\n   * ```javascript\n   * // Javascript Example\n   * await obniz.ble.initWait();\n   * try {\n   *   var peripheral = await obniz.ble.directConnectWait(\"e4b9efb29218\",\"random\");\n   *   console.log(\"connected\");\n   * } catch(e) {\n   *   console.log(\"can't connect\");\n   * }\n   * ```\n   *\n   * @param address peripheral device address\n   * @param addressType \"random\" or \"public\"\n   */\n  public async directConnectWait(address: BleDeviceAddress, addressType: BleDeviceAddressType) {\n    const peripheral: any = this.directConnect(address, addressType);\n    await peripheral.connectWait();\n    return peripheral;\n  }\n\n  /**\n   * @ignore\n   */\n  public warningIfNotInitialize() {\n    if (!this._initialized && this._initializeWarning) {\n      this._initializeWarning = true;\n      this.Obniz.warning({\n        alert: \"warning\",\n        message: `BLE is not initialized. Please call 'await obniz.ble.initWait()'`,\n      });\n    }\n  }\n\n  public schemaBasePath(): string {\n    return \"ble\";\n  }\n\n  protected onStateChange() {}\n\n  protected findPeripheral(address: BleDeviceAddress) {\n    for (const key in this.remotePeripherals) {\n      if (this.remotePeripherals[key].address === address) {\n        return this.remotePeripherals[key];\n      }\n    }\n    return null;\n  }\n\n  protected onDiscover(\n    uuid: any,\n    address?: any,\n    addressType?: any,\n    connectable?: any,\n    advertisement?: any,\n    rssi?: any,\n  ) {\n    let val: BleRemotePeripheral | null = this.findPeripheral(uuid);\n    if (!val) {\n      val = new BleRemotePeripheral(this, uuid);\n      this.remotePeripherals.push(val);\n    }\n    val.discoverdOnRemote = true;\n\n    const peripheralData: any = {\n      device_type: \"ble\",\n      address_type: addressType,\n      ble_event_type: connectable ? \"connectable_advertisemnt\" : \"non_connectable_advertising\",\n      rssi,\n      adv_data: advertisement.advertisementRaw,\n      scan_resp: advertisement.scanResponseRaw,\n    };\n\n    val.setParams(peripheralData);\n\n    this.scan.notifyFromServer(\"onfind\", val);\n  }\n\n  protected onDisconnect(peripheralUuid: any, reason: ObnizBleHciStateError) {\n    const peripheral: any = this.findPeripheral(peripheralUuid);\n    peripheral.notifyFromServer(\"statusupdate\", { status: \"disconnected\", reason });\n  }\n\n  //\n  // protected onServicesDiscover(peripheralUuid: any, serviceUuids?: any) {\n  //   const peripheral: any = this.findPeripheral(peripheralUuid);\n  //   for (const serviceUuid of serviceUuids) {\n  //     peripheral.notifyFromServer(\"discover\", { service_uuid: serviceUuid });\n  //   }\n  //   peripheral.notifyFromServer(\"discoverfinished\", {});\n  // }\n\n  // protected onIncludedServicesDiscover(peripheralUuid: any, serviceUuid?: any, includedServiceUuids?: any) {}\n\n  // protected onCharacteristicsDiscover(peripheralUuid: any, serviceUuid?: any, characteristics?: any) {\n  //   const peripheral: any = this.findPeripheral(peripheralUuid);\n  //   const service: any = peripheral.findService({ service_uuid: serviceUuid });\n  //   for (const char of characteristics) {\n  //     const obj: any = {\n  //       properties: char.properties.map((e: any) => BleHelper.toSnakeCase(e)),\n  //       characteristic_uuid: char.uuid,\n  //     };\n  //     service.notifyFromServer(\"discover\", obj);\n  //   }\n  //   service.notifyFromServer(\"discoverfinished\", {});\n  // }\n\n  protected onNotification(\n    peripheralUuid: any,\n    serviceUuid?: any,\n    characteristicUuid?: any,\n    data?: any,\n    isNotification?: any,\n    isSuccess?: any,\n  ) {\n    const peripheral: any = this.findPeripheral(peripheralUuid);\n    const characteristic: any = peripheral.findCharacteristic({\n      service_uuid: serviceUuid,\n      characteristic_uuid: characteristicUuid,\n    });\n\n    if (isNotification) {\n      const obj: any = {\n        data: Array.from(data),\n      };\n      characteristic.notifyFromServer(\"onnotify\", obj);\n    }\n  }\n\n  protected onPeripheralStateChange(state: any) {\n    // console.error(\"onPeripheralStateChange\")\n  }\n\n  protected onPeripheralAccept(clientAddress: any) {\n    this.peripheral.currentConnectedDeviceAddress = clientAddress;\n    if (this.peripheral.onconnectionupdates) {\n      this.peripheral.onconnectionupdates({\n        address: clientAddress,\n        status: \"connected\",\n      });\n    }\n  }\n\n  protected onPeripheralMtuChange(mtu: any) {\n    // console.error(\"onPeripheralMtuChange\")\n  }\n\n  protected onPeripheralDisconnect(clientAddress: any, reason: any) {\n    this.peripheral.currentConnectedDeviceAddress = null;\n    if (this.peripheral.onconnectionupdates) {\n      this.peripheral.onconnectionupdates({\n        address: clientAddress,\n        status: \"disconnected\",\n        reason,\n      });\n    }\n  }\n\n  protected _bind() {\n    this.centralBindings.on(\"stateChange\", this.onStateChange.bind(this));\n\n    this.centralBindings.on(\"discover\", this.onDiscover.bind(this));\n    this.centralBindings.on(\"disconnect\", this.onDisconnect.bind(this));\n    this.centralBindings.on(\"notification\", this.onNotification.bind(this));\n\n    this.peripheralBindings.on(\"stateChange\", this.onPeripheralStateChange.bind(this));\n    this.peripheralBindings.on(\"accept\", this.onPeripheralAccept.bind(this));\n    this.peripheralBindings.on(\"mtuChange\", this.onPeripheralMtuChange.bind(this));\n    this.peripheralBindings.on(\"disconnect\", this.onPeripheralDisconnect.bind(this));\n  }\n\n  private debug(text: any) {\n    this.debugHandler(text);\n  }\n}\n"]}