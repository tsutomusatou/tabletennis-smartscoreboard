{"version":3,"sources":["../src/obniz/libs/embeds/display.ts"],"names":[],"mappings":"AAAA;;;GAGG;AAGH,OAAO,EAAE,iBAAiB,EAAE,MAAM,qBAAqB,CAAC;AAExD;;;;GAIG;AACH,MAAM,CAAC,OAAO,OAAO,OAAQ,SAAQ,iBAAiB;IACpD;;;OAGG;IACH,SAAgB,KAAK,EAAE,MAAM,CAAC;IAE9B;;;OAGG;IACH,SAAgB,MAAM,EAAE,MAAM,CAAC;IAE/B,OAAO,CAAC,SAAS,CAAiB;IAClC,OAAO,CAAC,QAAQ,CAAc;IAC9B,OAAO,CAAC,OAAO,CAAC,CAAoB;IACpC,OAAO,CAAC,IAAI,CAAkB;IAC9B,OAAO,CAAC,uBAAuB,CAAiB;IAChD,OAAO,CAAC,WAAW,CAAa;IAChC,OAAO,CAAC,MAAM,CAAU;IACxB,OAAO,CAAC,YAAY,CAAQ;IAC5B,OAAO,CAAC,cAAc,CAAS;gBAEnB,KAAK,EAAE,GAAG,EAAE,IAAI,EAAE,GAAG;IAYjC;;;;;;;;;;;;;;;;;;;;;;;OAuBG;IACI,IAAI,CAAC,IAAI,EAAE,MAAM,GAAG,IAAI,EAAE,IAAI,CAAC,EAAE,MAAM;IAY9C;;;;;;;;;;;OAWG;IACI,QAAQ,CAAC,KAAK,EAAE,MAAM;IAO7B;;;;;;;OAOG;IACI,QAAQ;IAIf;;;;;;OAMG;IACI,KAAK;IAmBZ;;;;;;;;;;;;OAYG;IACI,GAAG,CAAC,CAAC,EAAE,MAAM,EAAE,CAAC,EAAE,MAAM;;;;IAW/B;;;;;;;;;;;;;;;;OAgBG;IACI,KAAK,CAAC,IAAI,EAAE,MAAM;IAezB;;;;;;;;;;;;;;;;;;;;;;;;OAwBG;IACI,IAAI,CAAC,GAAG,EAAE,MAAM,EAAE,GAAG,EAAE,MAAM,EAAE,GAAG,EAAE,MAAM,EAAE,GAAG,EAAE,MAAM;IAa9D;;;;;;;;;;;;;;;;;OAiBG;IACI,IAAI,CAAC,CAAC,EAAE,MAAM,EAAE,CAAC,EAAE,MAAM,EAAE,KAAK,EAAE,MAAM,EAAE,MAAM,EAAE,MAAM,EAAE,QAAQ,CAAC,EAAE,OAAO;IAcnF;;;;;;;;;;;;;;;OAeG;IACI,MAAM,CAAC,CAAC,EAAE,MAAM,EAAE,CAAC,EAAE,MAAM,EAAE,CAAC,EAAE,MAAM,EAAE,QAAQ,CAAC,EAAE,OAAO;IAgBjE;;;;;;;;;;;;;;;;;OAiBG;IACI,EAAE,CAAC,IAAI,EAAE,MAAM,EAAE,UAAU,CAAC,EAAE,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG;IAa1D;;;;;;;;;;;;;;;OAeG;IACI,GAAG,CAAC,IAAI,EAAE,MAAM,EAAE;IAWzB;;;;;;;;;;;;OAYG;IACI,aAAa,CAAC,KAAK,EAAE,MAAM;IAWlC;;;;;;OAMG;IACI,aAAa;IAIpB;;;;;OAKG;IACI,UAAU,CAAC,EAAE,EAAE,MAAM,EAAE,UAAU,EAAE,MAAM,EAAE,QAAQ,EAAE,MAAM;IAYlE;;;;OAIG;IACI,WAAW,CAAC,UAAU,EAAE,MAAM,EAAE,IAAI,EAAE,GAAG;IAiBhD;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;OA8CG;IACI,IAAI,CAAC,GAAG,EAAE,wBAAwB;IAMzC;;;;;;;;;;;;;;;;;;;;OAoBG;IACI,OAAO,CAAC,SAAS,EAAE,OAAO;IAQ1B,cAAc,IAAI,MAAM;IAI/B,SAAS,CAAC,MAAM;IAUhB,OAAO,CAAC,sBAAsB;IAQ9B,OAAO,CAAC,aAAa;IAYrB,OAAO,CAAC,eAAe;IAqCvB,OAAO,CAAC,IAAI;IAOZ,OAAO,CAAC,KAAK;CAwEd","file":"display.d.ts","sourcesContent":["/**\n * @packageDocumentation\n * @module ObnizCore.Components\n */\n\nimport Obniz from \"../../index\";\nimport { ComponentAbstract } from \"../ComponentAbstact\";\n\n/**\n * Here we will show letters and pictures on display on obniz Board.\n * ![](media://obniz_display_sphere.gif)\n * @category Embeds\n */\nexport default class Display extends ComponentAbstract {\n  /**\n   * display width size\n   * @readonly\n   */\n  public readonly width: number;\n\n  /**\n   * display height size\n   * @readonly\n   */\n  public readonly height: number;\n\n  private autoFlush: boolean = true;\n  private fontSize: number = 16;\n  private _canvas?: HTMLCanvasElement;\n  private _pos = { x: 0, y: 0 };\n  private _colorDepthCapabilities: [number] = [1];\n  private _colorDepth: number = 1;\n  private _color = \"#000\";\n  private _paper_white = true;\n  private _raw_alternate = false;\n\n  constructor(obniz: any, info: any) {\n    super(obniz);\n    this.width = info.width;\n    this.height = info.height;\n    this._colorDepthCapabilities = info.color_depth;\n    this._paper_white = info.paper_white;\n    this._raw_alternate = info.raw_alternate;\n\n    this._canvas = undefined;\n    this._reset();\n  }\n\n  /**\n   * (It does not work with node.js. Please use display.draw())\n   *\n   * This changes the font.\n   * The options for fontFamily and fontSize depend on your browser.\n   *\n   * The default font is Arial 16px.\n   * If you set the parameter to null, you will be using the default font.\n   *\n   * ```javascript\n   * // Javascript Example\n   * obniz.display.font('Avenir',30)\n   * obniz.display.print(\"Avenir\")\n   *\n   * obniz.display.font(null,30) //default font(Arial) 30px\n   * obniz.display.font('Avenir') //Avenir with default size(16px)\n   * ```\n   * ![](media://obniz_display_samples3.jpg)\n   * ![](media://obniz_display_samples2.jpg)\n   * ![](media://obniz_display_samples1.jpg)\n   *\n   * @param font font name\n   * @param size size of font\n   */\n  public font(font: string | null, size?: number) {\n    const ctx: any = this._ctx();\n    if (typeof size !== \"number\") {\n      size = 16;\n    }\n    if (typeof font !== \"string\") {\n      font = \"Arial\";\n    }\n    this.fontSize = size;\n    ctx.font = \"\" + +\" \" + size + \"px \" + font;\n  }\n\n  /**\n   * Setting color for fill/stroke style for further rendering.\n   *\n   * ```javascript\n   * obniz.display.color('#FF0000');\n   * obniz.display.rect(0, 0, 10, 10, false)\n   * obniz.display.color('blue');\n   * obniz.display.rect(0, 10, 10, 10, false)\n   * ```\n   *\n   * @param depth css acceptable color definition\n   */\n  public setColor(color: string) {\n    this._color = color;\n    const ctx: any = this._ctx();\n    ctx.fillStyle = this._color;\n    ctx.strokeStyle = this._color;\n  }\n\n  /**\n   * Getting color for fill/stroke style for further rendering.\n   *\n   * ```javascript\n   * const current = obniz.display.getColor();\n   * ```\n   *\n   */\n  public getColor() {\n    return this._color;\n  }\n\n  /**\n   * Clear the display.\n   * ```javascript\n   * // Javascript Example\n   * obniz.display.clear();\n   * ```\n   */\n  public clear() {\n    const ctx: any = this._ctx();\n    this._pos.x = 0;\n    this._pos.y = 0;\n    if (ctx) {\n      const currentFillStyle = ctx.fillStyle;\n      ctx.fillStyle = this._paper_white ? \"#FFF\" : \"#000\";\n      ctx.fillRect(0, 0, this.width, this.height);\n      ctx.fillStyle = currentFillStyle;\n      this.draw(ctx);\n    } else {\n      const obj: any = {};\n      obj.display = {\n        clear: true,\n      };\n      this.Obniz.send(obj);\n    }\n  }\n\n  /**\n   * (This does not work with node.js. Please use display.draw())\n   * It changes the display position of a text. If you are using print() to display a text, position it to top left.\n   *\n   * ```javascript\n   * // Javascript Example\n   * obniz.display.pos(0,30);\n   * obniz.display.print(\"YES. „Åì„Çì„Å´„Å°„ÅØ\");\n   * ```\n   * ![](media://obniz_display_pos.jpg)\n   *  @param x\n   *  @param y\n   */\n  public pos(x: number, y: number) {\n    this._ctx(); // crete first\n    if (typeof x === \"number\") {\n      this._pos.x = x;\n    }\n    if (typeof y === \"number\") {\n      this._pos.y = y;\n    }\n    return this._pos;\n  }\n\n  /**\n   * Print text on display.\n   *\n   * ```javascript\n   * // Javascript Example\n   * obniz.display.print(\"Hello!\");\n   * ```\n   *\n   * ```javascript\n   * // Javascript Example\n   * obniz.display.font('Serif',18)\n   * obniz.display.print(\"Hello Worldüß°\")\n   * ```\n   * ![](media://obniz_display_print.jpg)\n   *\n   *  @param text Text to display. With browser, UTF8 string is available. (It does not work with node.js. Please use display.draw())\n   */\n  public print(text: string) {\n    const ctx = this._ctx();\n    if (ctx) {\n      ctx.fillText(text, this._pos.x, this._pos.y + this.fontSize);\n      this.draw(ctx);\n      this._pos.y += this.fontSize;\n    } else {\n      const obj: any = {};\n      obj.display = {\n        text: \"\" + text,\n      };\n      this.Obniz.send(obj);\n    }\n  }\n\n  /**\n   * (It does not work with node.js. Please use display.draw())\n   *\n   *\n   * Now we draw a line between two points.\n   *\n   * ```javascript\n   * // Javascript Example\n   * obniz.display.line(30, 30, 100, 30);\n   * obniz.display.rect(20, 20, 20, 20);\n   * obniz.display.circle(100, 30, 20);\n   *\n   * obniz.display.line(60, 50, 100, 30);\n   * obniz.display.rect(50, 40, 20, 20, true);\n   * obniz.display.line(50, 10, 100, 30);\n   * obniz.display.circle(50, 10, 10, true);\n   * ```\n   *\n   * ![](media://obniz_display_draws.jpg)\n   *\n   * @param x_0\n   * @param y_0\n   * @param x_1\n   * @param y_1\n   */\n  public line(x_0: number, y_0: number, x_1: number, y_1: number) {\n    const ctx: any = this._ctx();\n    if (ctx) {\n      ctx.beginPath();\n      ctx.moveTo(x_0, y_0);\n      ctx.lineTo(x_1, y_1);\n      ctx.stroke();\n      this.draw(ctx);\n    } else {\n      this.warnCanvasAvailability();\n    }\n  }\n\n  /**\n   * (It does not work with node.js. Please use display.draw())\n   *\n   *\n   * This draws a rectangle.\n   *\n   * ```javascript\n   * // Javascript Example\n   * obniz.display.rect(10, 10, 20, 20);\n   * obniz.display.rect(20, 20, 20, 20, true); // filled rect\n   * ```\n   *\n   * @param x\n   * @param y\n   * @param width\n   * @param height\n   * @param mustFill\n   */\n  public rect(x: number, y: number, width: number, height: number, mustFill?: boolean) {\n    const ctx: any = this._ctx();\n    if (ctx) {\n      if (mustFill) {\n        ctx.fillRect(x, y, width, height);\n      } else {\n        ctx.strokeRect(x, y, width, height);\n      }\n      this.draw(ctx);\n    } else {\n      this.warnCanvasAvailability();\n    }\n  }\n\n  /**\n   * (It does not work with node.js. Please use display.draw())\n   *\n   * This draws a circle.\n   *\n   * ```javascript\n   * // Javascript Example\n   * obniz.display.circle(40, 30, 20);\n   * obniz.display.circle(90, 30, 20, true); // filled circle\n   * ```\n   *\n   * @param x\n   * @param y\n   * @param r\n   * @param mustFill\n   */\n  public circle(x: number, y: number, r: number, mustFill?: boolean) {\n    const ctx: any = this._ctx();\n    if (ctx) {\n      ctx.beginPath();\n      ctx.arc(x, y, r, 0, Math.PI * 2);\n      if (mustFill) {\n        ctx.fill();\n      } else {\n        ctx.stroke();\n      }\n      this.draw(ctx);\n    } else {\n      this.warnCanvasAvailability();\n    }\n  }\n\n  /**\n   * This shows QR code with given text and correction level.\n   * The correction level can be\n   *\n   * - L\n   * - M(default)\n   * - Q\n   * - H\n   *\n   * H is the strongest error correction.\n   *\n   * ```javascript\n   * // Javascript Example\n   * obniz.display.qr(\"https://obniz.io\")\n   * ```\n   * @param text\n   * @param correction\n   */\n  public qr(text: string, correction?: \"L\" | \"M\" | \"Q\" | \"H\") {\n    const obj: any = {};\n    obj.display = {\n      qr: {\n        text,\n      },\n    };\n    if (correction) {\n      obj.display.qr.correction = correction;\n    }\n    this.Obniz.send(obj);\n  }\n\n  /**\n   * Draw BMP image\n   *\n   * ```javascript\n   * obniz.display.raw([255, 255,,,,,])\n   * ```\n   *\n   * You should care about colorDepth before sending raw datas.\n   *\n   * @param data data array.\n   * The order is as below.\n   * {1byte} {2byte} {3byte}...{16byte}\n   * {17byte} {18byte} {19byte}...\n   * .....\n   * .....................\n   */\n  public raw(data: number[]) {\n    const obj: any = {};\n    obj.display = {\n      raw: data,\n    };\n    if (this._colorDepth > 1) {\n      obj.display.color_depth = this._colorDepth;\n    }\n    this.Obniz.send(obj);\n  }\n\n  /**\n   * Setting color depth for all communication for the display\n   * higher number will get more beautiful colors and lowest number 1 is just monochrome.\n   * But 16 bit color mode is 16 times data bytes needed for same size rendering.\n   *\n   * ```javascript\n   * obniz.display.setColorDepth(4); // => 4bit color mode.\n   * ```\n   *\n   * @param depth monochrome display always 1. For color display 1(monochrome) and 4 and 16 can be selected.\n   * default value is highest color depth for your display.\n   * If you call just\n   */\n  public setColorDepth(depth: number) {\n    const found = this._colorDepthCapabilities.find((element) => element === depth);\n    if (found) {\n      this._colorDepth = depth;\n    } else {\n      throw new Error(\n        `This device can't accept depth ${depth}. availables are ${JSON.stringify(this._colorDepthCapabilities)}`,\n      );\n    }\n  }\n\n  /**\n   * Getting color depth for all communication for the display\n   *\n   * ```javascript\n   * const current = obniz.display.getColorDepth(); // => return current depth. 1 or higher\n   * ```\n   */\n  public getColorDepth() {\n    return this._colorDepth;\n  }\n\n  /**\n   * @ignore\n   * @param io\n   * @param moduleName\n   * @param funcName\n   */\n  public setPinName(io: number, moduleName: string, funcName: string) {\n    const obj: any = {};\n    obj.display = {};\n    obj.display.pin_assign = {};\n    obj.display.pin_assign[io] = {\n      module_name: moduleName,\n      pin_name: funcName,\n    };\n\n    this.Obniz.send(obj);\n  }\n\n  /**\n   * @ignore\n   * @param moduleName\n   * @param data\n   */\n  public setPinNames(moduleName: string, data: any) {\n    const obj: any = {};\n    obj.display = {};\n    obj.display.pin_assign = {};\n    let noAssignee: any = true;\n    for (const key in data) {\n      noAssignee = false;\n      obj.display.pin_assign[key] = {\n        module_name: moduleName,\n        pin_name: data[key],\n      };\n    }\n    if (!noAssignee) {\n      this.Obniz.send(obj);\n    }\n  }\n\n  /**\n   * Draw Display from HTML5 Canvas context.\n   * With node-canvas, this works with node.js.\n   *\n   * - on HTML, load ctx from existing\n   *\n   * ```javascript\n   * let ctx = $(\"#canvas\")[0].getContext('2d');\n   *\n   * ctx.fillStyle = \"white\";\n   * ctx.font = \"30px Avenir\";\n   * ctx.fillText('Avenir', 0, 40);\n   *\n   * obniz.display.draw(ctx);\n   * ```\n   *\n   * - on HTML, create new canvas dom and load it.\n   *\n   * ```javascript\n   *\n   * let ctx = obniz.util.createCanvasContext(obniz.display.width, obniz.display.height);\n   *\n   * ctx.fillStyle = \"white\";\n   * ctx.font = \"30px Avenir\";\n   * ctx.fillText('Avenir', 0, 40);\n   *\n   * obniz.display.draw(ctx);\n   * ```\n   *\n   * - running with node.js\n   *\n   * ```javascript\n   * //    npm install canvas. ( version 2.0.0 or later required )\n   * const { createCanvas } = require('canvas');\n   * const canvas = createCanvas(128, 64);\n   * const ctx = canvas.getContext('2d');\n   *\n   * ctx.fillStyle = \"white\";\n   * ctx.font = \"30px Avenir\";\n   * ctx.fillText('Avenir', 0, 40);\n   *\n   * obniz.display.draw(ctx);\n   * ```\n   *\n   *\n   * @param ctx\n   */\n  public draw(ctx: CanvasRenderingContext2D) {\n    if (this.autoFlush) {\n      this._draw(ctx);\n    }\n  }\n\n  /**\n   * You can specify to transfer the displayed data or not.\n   * This affects only the functions that use canvas like clear/print/line/rect/circle/draw.\n   *\n   * Use false to stop updating display and true to restart updating.\n   *\n   * ```javascript\n   * // Javascript Example\n   * obniz.display.drawing(false);\n   * for (var i=0;i<100; i++) {\n   *   var x0 = Math.random() * 128;\n   *   var y0 = Math.random() * 64;\n   *   var x1 = Math.random() * 128;\n   *   var y1 = Math.random() * 64;\n   *   obniz.display.clear();\n   *   obniz.display.line(x0, y0, x1, y1);\n   * }\n   * obniz.display.drawing(true);\n   * ```\n   * @param autoFlush\n   */\n  public drawing(autoFlush: boolean) {\n    this.autoFlush = !!autoFlush;\n    const ctx: any = this._ctx();\n    if (ctx) {\n      this.draw(ctx);\n    }\n  }\n\n  public schemaBasePath(): string {\n    return \"display\";\n  }\n\n  protected _reset() {\n    this.autoFlush = true;\n    // reset to default\n    this._pos = { x: 0, y: 0 };\n    this._color = this._paper_white ? \"#000\" : \"#FFF\";\n    this.fontSize = this.height > 200 ? 32 : 16;\n    this._colorDepth = this._colorDepthCapabilities[this._colorDepthCapabilities.length - 1];\n    this._reset_canvas();\n  }\n\n  private warnCanvasAvailability() {\n    if (this.Obniz.isNode) {\n      throw new Error(\"obniz.js require node-canvas to draw rich contents. see more detail on docs\");\n    } else {\n      throw new Error(\"obniz.js cant create canvas element to body\");\n    }\n  }\n\n  private _reset_canvas() {\n    // reset canvas\n    if (this._canvas) {\n      const ctx: any = this._canvas!.getContext(\"2d\");\n      ctx.fillStyle = this._paper_white ? \"#FFF\" : \"#000\";\n      ctx.fillRect(0, 0, this.width, this.height);\n      ctx.fillStyle = this._color;\n      ctx.strokeStyle = this._color;\n      ctx.font = `${this.fontSize}px Arial`;\n    }\n  }\n\n  private _preparedCanvas() {\n    if (this._canvas) {\n      return this._canvas;\n    }\n    if (this.Obniz.isNode) {\n      try {\n        const { createCanvas } = require(\"canvas\");\n        this._canvas = createCanvas(this.width, this.height);\n      } catch (e) {\n        // this.warnCanvasAvailability();\n        return null;\n      }\n    } else {\n      const identifier: any = \"obnizcanvas-\" + this.Obniz.id;\n      let canvas: any = document.getElementById(identifier);\n      if (canvas) {\n        this._canvas = canvas;\n      } else {\n        canvas = document.createElement(\"canvas\");\n        canvas.setAttribute(\"id\", identifier);\n        canvas.style.visibility = \"hidden\";\n        canvas.width = this.width;\n        canvas.height = this.height;\n        if (this._colorDepthCapabilities.length === 1) {\n          // for monochro display\n          canvas.style[\"-webkit-font-smoothing\"] = \"none\";\n        }\n        const body: any = document.getElementsByTagName(\"body\")[0];\n        body.appendChild(canvas);\n\n        this._canvas = canvas;\n        this._reset_canvas();\n      }\n    }\n    return this._canvas;\n  }\n\n  private _ctx() {\n    const canvas: any = this._preparedCanvas();\n    if (canvas) {\n      return canvas.getContext(\"2d\");\n    }\n  }\n\n  private _draw(ctx: CanvasRenderingContext2D) {\n    const raw = new Array((this.width * this.height * this._colorDepth) / 8);\n    const imageData = ctx.getImageData(0, 0, this.width, this.height);\n    const data = imageData.data;\n\n    if (this._colorDepth === 16) {\n      for (let pixel_index = 0; pixel_index < this.width * this.height; pixel_index++) {\n        const red = data[pixel_index * 4];\n        const green = data[pixel_index * 4 + 1];\n        const blue = data[pixel_index * 4 + 2];\n        const hexColor = (((red >> 3) & 0x1f) << 11) | (((green >> 2) & 0x3f) << 5) | (((blue >> 3) & 0x1f) << 0);\n        raw[pixel_index * 2] = (hexColor >> 8) & 0xff;\n        raw[pixel_index * 2 + 1] = hexColor & 0xff;\n      }\n    } else if (this._colorDepth === 4) {\n      const stride = this.width / 2;\n      for (let pixel_index = 0; pixel_index < this.width * this.height; pixel_index++) {\n        const red = data[pixel_index * 4];\n        const green = data[pixel_index * 4 + 1];\n        const blue = data[pixel_index * 4 + 2];\n        const brightness = 0.34 * red + 0.5 * green + 0.16 * blue;\n        const line = Math.floor(pixel_index / this.width);\n        const col = Math.floor((pixel_index - line * this.width) / 2);\n        const bits = Math.floor(pixel_index - line * this.width) % 2;\n\n        let pixel = 0b0000;\n        if (red > 0x7f) {\n          pixel |= 0b1000;\n        }\n        if (green > 0x7f) {\n          pixel |= 0b0100;\n        }\n        if (blue > 0x7f) {\n          pixel |= 0b0010;\n        }\n        if (brightness > 0x7f) {\n          pixel |= 0b0001;\n        }\n\n        if (bits === 0) {\n          raw[line * stride + col] = pixel << 4;\n        } else {\n          raw[line * stride + col] |= pixel;\n        }\n      }\n    } else {\n      const stride = this.width / 8;\n      for (let pixel_index = 0; pixel_index < this.width * this.height; pixel_index++) {\n        const red = data[pixel_index * 4];\n        const green = data[pixel_index * 4 + 1];\n        const blue = data[pixel_index * 4 + 2];\n        const brightness = 0.34 * red + 0.5 * green + 0.16 * blue;\n        const row = Math.floor(pixel_index / this.width);\n        const col = Math.floor((pixel_index - row * this.width) / 8);\n        const bits = Math.floor(pixel_index - row * this.width) % 8;\n        if (bits === 0) {\n          raw[row * stride + col] = 0x00;\n        }\n\n        if (brightness > 0x7f) {\n          raw[row * stride + col] |= 0x80 >> bits;\n        }\n      }\n    }\n    if (this._raw_alternate) {\n      for (let i = 0; i < raw.length; i++) {\n        raw[i] = ~raw[i] & 0xff;\n      }\n    }\n\n    this.raw(raw);\n  }\n}\n"]}