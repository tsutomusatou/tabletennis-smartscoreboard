{"version":3,"sources":["../src/parts/DistanceSensor/VL53L0X/index.ts"],"names":[],"mappings":"AAAA;;;GAGG;AAEH,OAAO,KAAK,MAAM,gBAAgB,CAAC;AACnC,OAAO,aAAa,MAAM,wCAAwC,CAAC;AAEnE,OAAO,mBAAmB,EAAE,EAAE,cAAc,EAAE,MAAM,oCAAoC,CAAC;AACzF,OAAO,EAAE,uBAAuB,EAAE,MAAM,gBAAgB,CAAC;AAEzD,MAAM,WAAW,cAAe,SAAQ,uBAAuB;CAAG;AAElE,MAAM,CAAC,OAAO,OAAO,OAAQ,YAAW,mBAAmB;WAC3C,IAAI,IAAI,cAAc;IAM7B,YAAY,EAAE,MAAM,EAAE,CAAC;IACvB,IAAI,EAAE,MAAM,EAAE,CAAC;IACf,MAAM,EAAE,GAAG,CAAC;IAEZ,OAAO,EAAE,MAAM,CAAC;IAChB,IAAI,EAAE,GAAG,CAAC;IAEV,IAAI,EAAE,MAAM,CAAC;IACb,IAAI,EAAE,MAAM,CAAC;IACb,MAAM,EAAE,MAAM,CAAC;IAEtB,SAAS,CAAC,KAAK,EAAG,KAAK,CAAC;IACxB,SAAS,CAAC,GAAG,EAAG,aAAa,CAAC;;IAoBvB,KAAK,CAAC,KAAK,EAAE,KAAK;IAUZ,OAAO;IA4BpB,OAAO,CAAC,UAAU;CAGnB","file":"index.d.ts","sourcesContent":["/**\n * @packageDocumentation\n * @module Parts.VL53L0X\n */\n\nimport Obniz from \"../../../obniz\";\nimport PeripheralI2C from \"../../../obniz/libs/io_peripherals/i2c\";\n\nimport ObnizPartsInterface, { ObnizPartsInfo } from \"../../../obniz/ObnizPartsInterface\";\nimport { I2cPartsAbstractOptions } from \"../../i2cParts\";\n\nexport interface VL53L0XOptions extends I2cPartsAbstractOptions {}\n\nexport default class VL53L0X implements ObnizPartsInterface {\n  public static info(): ObnizPartsInfo {\n    return {\n      name: \"VL53L0X\",\n    };\n  }\n\n  public requiredKeys: string[];\n  public keys: string[];\n  public params: any;\n\n  public address: number;\n  public regs: any;\n\n  public acnt: number;\n  public scnt: number;\n  public status: number;\n\n  protected obniz!: Obniz;\n  protected i2c!: PeripheralI2C;\n\n  constructor() {\n    this.requiredKeys = [];\n    this.keys = [\"vcc\", \"gnd\", \"sda\", \"scl\", \"i2c\"];\n    this.address = 0x29;\n    this.regs = {\n      IDENTIFICATION_MODEL_ID: 0xc0,\n      IDENTIFICATION_REVISION_ID: 0xc2,\n      PRE_RANGE_CONFIG_VCSEL_PERIOD: 0x50,\n      FINAL_RANGE_CONFIG_VCSEL_PERIOD: 0x70,\n      SYSRANGE_START: 0x00,\n      RESULT_INTERRUPT_STATUS: 0x13,\n      RESULT_RANGE_STATUS: 0x14,\n    };\n    this.acnt = 0;\n    this.scnt = 0;\n    this.status = 0;\n  }\n\n  public wired(obniz: Obniz) {\n    this.obniz = obniz;\n    this.obniz.setVccGnd(this.params.vcc, this.params.gnd, \"3v\");\n    this.obniz.wait(100);\n    this.params.clock = 100000;\n    this.params.pull = \"3v\";\n    this.params.mode = \"master\";\n    this.i2c = obniz.getI2CWithConfig(this.params);\n  }\n\n  public async getWait() {\n    this.i2c.write(this.address, [this.regs.SYSRANGE_START, 0x01]);\n    let val = [0];\n    let cnt: number = 0;\n    while (cnt < 10) {\n      await this.obniz.wait(10);\n      this.i2c.write(this.address, [this.regs.RESULT_RANGE_STATUS]);\n      val = await this.i2c.readWait(this.address, 1);\n      if (val[0] & 0x01) {\n        break;\n      } else {\n        cnt++;\n      }\n    }\n    if (!(val[0] & 0x01)) {\n      return null;\n    } // sensor not ready\n\n    this.i2c.write(this.address, [0x14]);\n    const gbuf = await this.i2c.readWait(this.address, 12);\n    this.acnt = this.makeuint16(gbuf[7], gbuf[6]);\n    this.scnt = this.makeuint16(gbuf[9], gbuf[8]);\n    const dist = this.makeuint16(gbuf[11], gbuf[10]);\n    this.status = (gbuf[0] & 0x78) >> 3;\n\n    return dist;\n  }\n\n  private makeuint16(lsb: number, msb: number): number {\n    return ((msb & 0xff) << 8) | (lsb & 0xff);\n  }\n}\n"]}