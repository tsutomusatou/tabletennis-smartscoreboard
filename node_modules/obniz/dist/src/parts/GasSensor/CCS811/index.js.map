{"version":3,"sources":["../src/parts/GasSensor/CCS811/index.ts"],"names":[],"mappings":"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","file":"index.js","sourcesContent":["/**\n * @packageDocumentation\n * @module Parts.CCS811\n */\n\nimport Obniz from \"../../../obniz\";\nimport { PullType } from \"../../../obniz/libs/io_peripherals/common\";\nimport PeripheralIO from \"../../../obniz/libs/io_peripherals/io\";\nimport ObnizPartsInterface, { ObnizPartsInfo } from \"../../../obniz/ObnizPartsInterface\";\nimport i2cParts, { I2cInfo, I2cPartsAbstractOptions } from \"../../i2cParts\";\n\nexport interface CCS811Options extends I2cPartsAbstractOptions {\n  pull?: PullType;\n  nwak?: number;\n  nrst?: number;\n  nint?: number;\n  add?: number;\n  address?: number;\n}\n\nexport default class CCS811 extends i2cParts implements ObnizPartsInterface {\n  public static info(): ObnizPartsInfo {\n    return {\n      name: \"CCS811\",\n      // datasheet: \"\",\n    };\n  }\n  public i2cinfo: I2cInfo;\n  public keys: string[];\n  public requiredKeys: string[];\n  public ioKeys?: string[] | undefined;\n  public params: any;\n  public commands: any;\n  public io_add?: PeripheralIO;\n  public io_nwak?: PeripheralIO;\n  public io_nrst?: PeripheralIO;\n\n  constructor() {\n    super();\n    this.i2cinfo = {\n      address: 0x5b,\n      clock: 100000,\n      voltage: \"3v\",\n      pull: \"3v\",\n    };\n    this.requiredKeys = [];\n    this.keys = [\"vcc\", \"gnd\", \"scl\", \"sda\", \"nwak\", \"nrst\", \"nint\", \"i2c\", \"add\", \"address\"];\n    this.ioKeys = [\"vcc\", \"gnd\", \"scl\", \"sda\", \"nwak\", \"nrst\", \"nint\", \"add\"];\n\n    this.commands = {};\n    this.commands.addresses = {\n      CCS811_STATUS: 0x00,\n      CCS811_MEAS_MODE: 0x01,\n      CCS811_ALG_RESULT_DATA: 0x02,\n      CCS811_RAW_DATA: 0x03,\n      CCS811_ENV_DATA: 0x05,\n      CCS811_NTC: 0x06,\n      CCS811_THRESHOLDS: 0x10,\n      CCS811_BASELINE: 0x11,\n      CCS811_HW_ID: 0x20,\n      CCS811_HW_VERSION: 0x21,\n      CCS811_FW_BOOT_VERSION: 0x23,\n      CCS811_FW_APP_VERSION: 0x24,\n      CCS811_ERROR_ID: 0xe0,\n      CCS811_APP_START: 0xf4,\n      CCS811_SW_RESET: 0xff,\n    };\n  }\n\n  public i2cInfo() {\n    return this.i2cinfo;\n  }\n\n  public wired(obniz: Obniz): void {\n    this.obniz = obniz;\n\n    this.obniz.setVccGnd(this.params.vcc, null, \"3v\");\n    this.obniz.setVccGnd(null, this.params.gnd, \"5v\");\n    this.obniz.wait(10);\n\n    this.address = 0x5b;\n    if (this.params.address === 0x5b) {\n      this.address = 0x5b;\n    } else if (this.params.address === 0x5a) {\n      this.address = 0x5a;\n    } else if (this.params.address !== undefined) {\n      throw new Error(\"address must be 0x5a or 0x5b\");\n    }\n\n    if (obniz.isValidIO(this.params.add)) {\n      this.io_add = obniz.getIO(this.params.add);\n      this.io_add.drive(\"3v\");\n      this.io_add.output(this.address === 0x5a ? false : true);\n    }\n\n    if (this.params.i2c !== undefined) {\n      this.i2c = this.params.i2c;\n    } else {\n      this.params.clock = this.params.clock || 100 * 1000;\n      this.params.mode = \"master\";\n      this.params.pull = \"3v\";\n      this.i2c = obniz.getI2CWithConfig(this.params);\n    }\n\n    this.obniz.wait(10);\n  }\n\n  public async configWait() {\n    // restart\n    const readCheck = await this.readWait(this.commands.addresses.CCS811_HW_ID, 1);\n    if (readCheck[0] !== 0x81) {\n      console.log(\"readCheck error \" + readCheck);\n    }\n    await this.obniz.wait(10);\n    console.log(\"restarted\");\n\n    // reset\n    this.write(this.commands.addresses.CCS811_SW_RESET, [0x11, 0xe5, 0x72, 0x8a]);\n    await this.obniz.wait(10);\n    console.log(\"reset\");\n\n    // checkForStatusError\n    const status = await this.readWait(this.commands.addresses.CCS811_STATUS, 1);\n    console.log(\"Status: \" + status);\n\n    this.start();\n    await this.setDriveModeWait(1); // Read every second\n    await this.obniz.wait(10);\n    console.log(\"config done\");\n  }\n\n  public start() {\n    this.write(this.commands.addresses.CCS811_APP_START, []);\n  }\n\n  // Mode 0 = Idle\n  // Mode 1 = read every 1s\n  // Mode 2 = every 10s\n  // Mode 3 = every 60s\n  // Mode 4 = RAW mode\n  public async setDriveModeWait(mode: number) {\n    if (mode > 4) {\n      mode = 4;\n    } // sanitize input\n    let value: number = await this.getMeasModeWait();\n    value &= ~(0b00000111 << 4); // Clear DRIVE_MODE bits\n    value |= mode << 4; // Mask in mode\n    this.write(this.commands.addresses.CCS811_MEAS_MODE, value);\n  }\n\n  public async getMeasModeWait(): Promise<number> {\n    const meas_mode = await this.readWait(this.commands.addresses.CCS811_MEAS_MODE, 1); // Read what's currently there\n    return meas_mode[0];\n  }\n  public async getDriveModeWait(): Promise<number> {\n    const meas_mode: number = await this.getMeasModeWait();\n    let drive_mode = meas_mode >>> 4;\n    if (drive_mode > 8) {\n      drive_mode -= 8;\n    }\n    return drive_mode;\n  }\n\n  public async setEnvironmentalDataWait(relativeHumidity: number, temperature: number): Promise<void> {\n    // Check for invalid temperatures\n    if (temperature < -25 || temperature > 50) {\n      console.log(\"temperature is out of range\");\n    }\n    // Check for invalid humidity\n    if (relativeHumidity < 0 || relativeHumidity > 100) {\n      console.log(\"humidity is out of range\");\n    }\n\n    const rH = relativeHumidity * 1000; // 42.348 becomes 42348\n    let temp = temperature * 1000; // 23.2 becomes 23200\n    const envData = [];\n    envData[0] = Math.round((rH + 250) / 500);\n    envData[1] = 0; // CCS811 only supports increments of 0.5 so bits 7-0 will always be zero\n    temp += 25000; // Add the 25C offset\n    envData[2] = Math.round((temp + 250) / 500);\n    envData[3] = 0;\n    // console.log(\"envData: \", envData);\n    this.write(this.commands.addresses.CCS811_ENV_DATA, envData);\n  }\n\n  // Checks to see if DATA_READ flag is set in the status register\n  public async checkAvailableDataWait(): Promise<boolean> {\n    const value = (await this.readWait(this.commands.addresses.CCS811_STATUS, 1))[0];\n    return Boolean(value & (1 << 3));\n  }\n\n  public async readAlgorithmResultsWait(): Promise<{ eCO2: number; TVOC: number }> {\n    const data = await this.readWait(this.commands.addresses.CCS811_ALG_RESULT_DATA, 8);\n    // Data ordered:\n    // co2MSB, co2LSB, tvocMSB, tvocLSB\n    const eCO2 = (data[0] << 8) | data[1];\n    const TVOC = (data[2] << 8) | data[3];\n    return { eCO2, TVOC };\n  }\n\n  public async geteCO2Wait(): Promise<number> {\n    return (await this.readAlgorithmResultsWait()).eCO2;\n  }\n  public async getTVOCWait(): Promise<number> {\n    return (await this.readAlgorithmResultsWait()).TVOC;\n  }\n\n  public wake(): void {\n    this.io_nwak = this.obniz.getIO(this.params.nwak);\n    this.io_nwak.drive(\"3v\");\n    this.io_nwak.output(false);\n  }\n\n  public sleep(): void {\n    this.io_nwak = this.obniz.getIO(this.params.nwak);\n    this.io_nwak.drive(\"3v\");\n    this.io_nwak.output(true);\n  }\n\n  public async hwResetWait(): Promise<void> {\n    this.io_nrst = this.obniz.getIO(this.params.nrst);\n    this.io_nrst.drive(\"3v\");\n    this.io_nrst.output(false);\n    await this.obniz.wait(10);\n    this.io_nrst.output(true);\n  }\n}\n"]}