{"version":3,"sources":["../src/parts/Ble/LogttaTemp/index.ts"],"names":[],"mappings":"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","file":"index.js","sourcesContent":["/**\n * @packageDocumentation\n * @module Parts.Logtta_TH\n */\n\nimport BleRemotePeripheral from \"../../../obniz/libs/embeds/bleHci/bleRemotePeripheral\";\nimport ObnizPartsBleInterface, { ObnizPartsBleInfo } from \"../../../obniz/ObnizPartsBleInterface\";\n\nexport interface Logtta_THOptions {}\n\nexport interface Logtta_TH_Data {\n  temperature: number;\n  humidity: number;\n}\n\nexport interface Logtta_TH_Adv_Data {\n  temperature: number;\n  humidity: number;\n  battery: number;\n  interval: number;\n  address: string;\n}\n\nexport default class Logtta_TH implements ObnizPartsBleInterface {\n  public static info(): ObnizPartsBleInfo {\n    return {\n      name: \"Logtta_TH\",\n    };\n  }\n\n  public static isDevice(peripheral: BleRemotePeripheral) {\n    return peripheral.localName === \"TH Sensor\";\n  }\n\n  public static isAdvDevice(peripheral: BleRemotePeripheral) {\n    if (peripheral.adv_data.length !== 31) {\n      return false;\n    }\n    const data = peripheral.adv_data;\n    if (Logtta_TH.getName(data) !== \"TH Sensor\") {\n      return false;\n    }\n    return true;\n  }\n\n  public static getData(peripheral: BleRemotePeripheral): Logtta_TH_Adv_Data | null {\n    if (peripheral.adv_data.length !== 31) {\n      return null;\n    }\n    const data: number[] = peripheral.adv_data;\n    if (Logtta_TH.getName(data) !== \"TH Sensor\") {\n      return null;\n    }\n    const alert: number = data[15];\n    const interval: number = (data[13] << 8) | data[14];\n    const advData: Logtta_TH_Adv_Data = {\n      battery: data[12],\n      temperature: (((data[8] << 8) | data[9]) / 65536) * 175.72 - 46.85,\n      humidity: (((data[10] << 8) | data[11]) / 65536) * 125 - 6,\n      interval,\n      address: peripheral.address,\n    };\n    return advData;\n  }\n\n  private static getName(data: number[]) {\n    let name: string = \"\";\n    for (let i = 16; i < data.length; i++) {\n      if (data[i] === 0) {\n        break;\n      }\n      name += String.fromCharCode(data[i]);\n    }\n    return name;\n  }\n\n  private static get_uuid(uuid: string): string {\n    return `f7ee${uuid}-276e-4165-aa69-7e3de7fc627e`;\n  }\n\n  public onNotify?: (data: Logtta_TH_Data) => void;\n  public _peripheral: null | BleRemotePeripheral;\n  public ondisconnect?: (reason: any) => void;\n\n  constructor(peripheral: BleRemotePeripheral | null) {\n    if (peripheral && !Logtta_TH.isDevice(peripheral)) {\n      throw new Error(\"peripheral is not logtta TH\");\n    }\n    this._peripheral = peripheral;\n  }\n\n  public async connectWait() {\n    if (!this._peripheral) {\n      throw new Error(\"Logtta TH not found\");\n    }\n    if (!this._peripheral.connected) {\n      this._peripheral.ondisconnect = (reason: any) => {\n        if (typeof this.ondisconnect === \"function\") {\n          this.ondisconnect(reason);\n        }\n      };\n      await this._peripheral.connectWait();\n    }\n  }\n\n  public async disconnectWait() {\n    if (this._peripheral && this._peripheral.connected) {\n      await this._peripheral.disconnectWait();\n    }\n  }\n\n  public async getAllWait(): Promise<Logtta_TH_Data | null> {\n    if (!(this._peripheral && this._peripheral.connected)) {\n      return null;\n    }\n\n    const c = this._peripheral!.getService(Logtta_TH.get_uuid(\"AA20\"))!.getCharacteristic(Logtta_TH.get_uuid(\"AA21\"));\n    const data: number[] = await c!.readWait();\n    return {\n      temperature: (((data[0] << 8) | data[1]) / 65536) * 175.72 - 46.85,\n      humidity: (((data[2] << 8) | data[3]) / 65536) * 125 - 6,\n    };\n  }\n\n  public async getTemperatureWait(): Promise<number> {\n    return (await this.getAllWait())!.temperature;\n  }\n\n  public async getHumidityWait(): Promise<number> {\n    return (await this.getAllWait())!.humidity;\n  }\n\n  public async startNotifyWait() {\n    if (!(this._peripheral && this._peripheral.connected)) {\n      return;\n    }\n\n    const c = this._peripheral!.getService(Logtta_TH.get_uuid(\"AA20\"))!.getCharacteristic(Logtta_TH.get_uuid(\"AA21\"));\n\n    await c!.registerNotifyWait((data: number[]) => {\n      if (this.onNotify) {\n        this.onNotify({\n          temperature: (((data[0] << 8) | data[1]) / 65536) * 175.72 - 46.85,\n          humidity: (((data[2] << 8) | data[3]) / 65536) * 125 - 6,\n        });\n      }\n    });\n  }\n\n  public async authPinCodeWait(code: string) {\n    if (!(this._peripheral && this._peripheral.connected)) {\n      return;\n    }\n\n    if (code.length !== 4) {\n      throw new Error(\"Invalid length auth code\");\n    }\n\n    const data: [number] = [0];\n    for (let i = 0; i < code.length; i += 2) {\n      data.push((this.checkNumber(code.charAt(i)) << 4) | this.checkNumber(code.charAt(i + 1)));\n    }\n    const c = this._peripheral!.getService(Logtta_TH.get_uuid(\"AA20\"))!.getCharacteristic(Logtta_TH.get_uuid(\"AA30\"));\n    await c!.writeWait(data);\n  }\n\n  // 有効にしたあと、切断するとビーコンが発信される\n  public async setBeaconMode(enable: boolean) {\n    if (!(this._peripheral && this._peripheral.connected)) {\n      return;\n    }\n\n    const c = this._peripheral!.getService(Logtta_TH.get_uuid(\"AA20\"))!.getCharacteristic(Logtta_TH.get_uuid(\"AA2D\"));\n    if (enable) {\n      await c!.writeWait([1]);\n    } else {\n      await c!.writeWait([0]);\n    }\n  }\n\n  private checkNumber(data: string) {\n    if (data >= \"0\" && data <= \"9\") {\n      return parseInt(data, 10);\n    } else {\n      throw new Error(`authorization code can only be entered from 0-9.input word : ${data}`);\n    }\n  }\n}\n"]}