{"version":3,"sources":["../src/parts/Ble/linking/modules/device.ts"],"names":[],"mappings":"AAAA;;;GAGG;AAWH,OAAO,mBAAmB,MAAM,0DAA0D,CAAC;AAI3F,MAAM,CAAC,OAAO,OAAO,aAAa;IACzB,oBAAoB,SAAsC;IAC1D,0BAA0B,SAAsC;IAChE,6BAA6B,SAAsC;IACnE,IAAI,EAAE,GAAG,CAAM;IACf,aAAa,EAAE,GAAG,CAAC;IACnB,SAAS,UAAS;IAClB,SAAS,EAAE,GAAG,CAAQ;IACtB,iBAAiB,EAAE,GAAG,CAAQ;IAC9B,YAAY,EAAE,GAAG,CAAQ;IACzB,QAAQ,EAAE,GAAG,CAAQ;IACrB,QAAQ,EAAE,GAAG,CAgBlB;IAEF,OAAO,CAAC,WAAW,CAAuB;IAC1C,OAAO,CAAC,QAAQ,CAAa;IAC7B,OAAO,CAAC,UAAU,CAAkC;IACpD,OAAO,CAAC,aAAa,CAAkC;IACvD,OAAO,CAAC,iBAAiB,CAAW;IACpC,OAAO,CAAC,eAAe,CAAwB;IAC/C,OAAO,CAAC,WAAW,CAAa;IAChC,OAAO,CAAC,uBAAuB,CAAc;IAC7C,OAAO,CAAC,uBAAuB,CAO7B;gBAEU,UAAU,EAAE,mBAAmB;IAM9B,OAAO;IA2Gb,KAAK,CAAC,IAAI,EAAE,MAAM;IASlB,2BAA2B;IAiB3B,2BAA2B;IAiB3B,oBAAoB,CAAC,IAAI,EAAE,MAAM;IAwCjC,WAAW,CAAC,CAAC,EAAE,GAAG;IAIlB,oBAAoB;IAyBd,qBAAqB;IAM3B,eAAe,CAAC,GAAG,EAAE,GAAG;IAaxB,iBAAiB,CAAC,GAAG,EAAE,GAAG;IAK1B,iBAAiB,CAAC,GAAG,EAAE,GAAG;IAuJpB,UAAU;IAWV,MAAM;IAiBZ,KAAK,CAAC,YAAY,EAAE,GAAG,EAAE,MAAM,CAAC,EAAE,GAAG;IAkCrC,uBAAuB,CAAC,GAAG,EAAE,GAAG;IAoBhC,aAAa;IAgGb,cAAc;IAgBd,cAAc,CAAC,IAAI,EAAE,MAAM;IAyB3B,UAAU,CAAC,KAAK,EAAE,GAAG,EAAE,OAAO,EAAE,GAAG,EAAE,QAAQ,EAAE,GAAG;IA4DlD,WAAW;IAiBX,gBAAgB,CAAC,OAAO,EAAE,GAAG,EAAE,QAAQ,EAAE,GAAG;IA2C5C,iBAAiB;IAiBjB,0BAA0B,CAAC,WAAW,EAAE,GAAG;;;;;;IAe3C,oBAAoB,CAAC,WAAW,EAAE,GAAG,EAAE,MAAM,EAAE,GAAG;IAgBlD,cAAc,CAAC,WAAW,EAAE,GAAG;CAyBvC","file":"device.d.ts","sourcesContent":["/**\n * @packageDocumentation\n * @module Parts.Linking\n */\n\n/* ------------------------------------------------------------------\n * node-linking - device.js\n *\n * Copyright (c) 2017-2019, Futomi Hatano, All rights reserved.\n * Released under the MIT license\n * Date: 2019-11-03\n * ---------------------------------------------------------------- */\n\"use strict\";\nimport BleRemoteCharacteristic from \"../../../../obniz/libs/embeds/bleHci/bleRemoteCharacteristic\";\nimport BleRemotePeripheral from \"../../../../obniz/libs/embeds/bleHci/bleRemotePeripheral\";\nimport LinkingAdvertising from \"./advertising\";\nimport LinkingService from \"./service\";\n\nexport default class LinkingDevice {\n  public PRIMARY_SERVICE_UUID = \"b3b3690150d34044808d50835b13a6cd\";\n  public WRITE_CHARACTERRISTIC_UUID = \"b3b3910150d34044808d50835b13a6cd\";\n  public INDICATE_CHARACTERRISTIC_UUID = \"b3b3910250d34044808d50835b13a6cd\";\n  public info: any = {};\n  public advertisement: any;\n  public connected = false;\n  public onconnect: any = null;\n  public onconnectprogress: any = null;\n  public ondisconnect: any = null;\n  public onnotify: any = null;\n  public services: any = {\n    deviceName: null,\n    led: null,\n    vibration: null,\n    button: null,\n    gyroscope: null,\n    accelerometer: null,\n    orientation: null,\n    battery: null,\n    temperature: null,\n    humidity: null,\n    pressure: null,\n    openclose: null,\n    human: null,\n    move: null,\n    illuminance: null,\n  };\n\n  private _peripheral!: BleRemotePeripheral;\n  private _service: any = null;\n  private char_write!: BleRemoteCharacteristic | null;\n  private char_indicate!: BleRemoteCharacteristic | null;\n  private _div_packet_queue: any = [];\n  private _LinkingService = new LinkingService();\n  private _onresponse: any = null;\n  private _write_response_timeout: any = 30000; // msec\n  private _generic_access_service: any = {\n    SERVICE_UUID: \"1800\",\n    service: null,\n    device_name: {\n      CHARACTERRISTIC_UUID: \"2a00\",\n      char: null,\n    },\n  };\n\n  constructor(peripheral: BleRemotePeripheral) {\n    this.advertisement = LinkingAdvertising.parse(peripheral);\n\n    this._peripheral = peripheral;\n  }\n\n  public async connect() {\n    if (this.connected === true) {\n      throw new Error(\"The device has been already connected.\");\n    }\n    let onprogress = this.onconnectprogress;\n    if (!this._isFunction(this.onconnectprogress)) {\n      onprogress = () => {};\n    }\n    const peripheral = this._peripheral;\n    onprogress({ step: 1, desc: \"CONNECTING\" });\n    try {\n      peripheral.ondisconnect = async () => {\n        await this._clean();\n        if (this._isFunction(this.ondisconnect)) {\n          this.ondisconnect({ wasClean: false });\n        }\n      };\n      await peripheral.connectWait();\n      onprogress({ step: 2, desc: \"CONNECTION_ESTABLISHED\" });\n      onprogress({ step: 3, desc: \"GETTING_CHARACTERISTICS\" });\n      await this._getServicesAndChars();\n      onprogress({ step: 4, desc: \"SUBSCRIBING\" });\n      await this._subscribeForIndicate();\n      onprogress({ step: 5, desc: \"GETTING_DEVICE_INFOMATION\" });\n      let res: any;\n      res = await this.write(\"GET_DEVICE_INFORMATION\");\n      this.info.id = \"\";\n      if (\"deviceId\" in res.data) {\n        this.info.id = res.data.deviceId;\n      }\n      this.info.uid = \"\";\n      if (\"deviceUid\" in res.data) {\n        this.info.uid = res.data.deviceUid;\n      }\n      this.info.services = {};\n      if (\"serviceList\" in res.data) {\n        res.data.serviceList.forEach((o: any) => {\n          this.info.services[o.name] = o.id;\n        });\n      }\n      this.info.capabilities = {};\n      if (\"deviceCapability\" in res.data) {\n        res.data.deviceCapability.forEach((o: any) => {\n          this.info.capabilities[o.name] = o.id;\n        });\n      }\n      this.info.exsensors = {};\n      if (\"exSensorType\" in res.data) {\n        res.data.exSensorType.forEach((o: any) => {\n          this.info.exsensors[o.name] = o.id;\n        });\n      }\n      onprogress({ step: 6, desc: \"GETTING_NOTIFY_CATEGORIES\" });\n      res = await this._writeConfirmNotifyCategory();\n      this.info.notifyCategories = {};\n      if (res) {\n        if (\"notifyCategory\" in res.data) {\n          res.data.notifyCategory.forEach((o: any) => {\n            this.info.notifyCategories[o.name] = o.id;\n          });\n        }\n      }\n      onprogress({ step: 7, desc: \"GETTING_SETTING_INFORMATION\" });\n      res = await this._writeGetSettingInformation();\n      this.info.settings = {};\n      if (res) {\n        if (\"settingInformationData\" in res.data) {\n          res.data.settingInformationData.forEach((o: any) => {\n            this.info.settings[o.name] = o;\n          });\n        }\n      }\n      onprogress({ step: 8, desc: \"GETTING_LED_COLOR_NAMES\" });\n      res = await this._writeGetSettingName(\"LEDColorName\");\n      if (res) {\n        this.info.settings.LED.colors = res.data.settingNameData;\n      }\n      onprogress({ step: 9, desc: \"GETTING_LED_PATTERN_NAMES\" });\n      res = await this._writeGetSettingName(\"LEDPatternName\");\n      if (res) {\n        this.info.settings.LED.patterns = res.data.settingNameData;\n      }\n      onprogress({ step: 10, desc: \"GETTING_VIBRATION_PATTERN_NAMES\" });\n      res = await this._writeGetSettingName(\"VibrationPatternName\");\n      if (res) {\n        this.info.settings.Vibration.patterns = res.data.settingNameData;\n      }\n      onprogress({ step: 11, desc: \"GETTING_BEEP_PATTERN_NAMES\" });\n      res = await this._writeGetSettingName(\"BeepPatternName\");\n      if (res) {\n        this.info.settings.Beep.patterns = res.data.settingNameData;\n      }\n      this._LinkingService.setDeviceInfo(this.info);\n      this._initServices();\n\n      this.connected = true;\n      if (this._isFunction(this.onconnect)) {\n        this.onconnect();\n      }\n\n      onprogress({ step: 12, desc: \"COMPLETED\" });\n    } catch (e) {\n      onprogress({ step: 0, desc: \"FAILED\" });\n      throw e;\n    }\n  }\n\n  public _wait(msec: number) {\n    const promise = new Promise((resolve, reject) => {\n      setTimeout(() => {\n        resolve();\n      }, msec);\n    });\n    return promise;\n  }\n\n  public _writeConfirmNotifyCategory() {\n    const promise = new Promise((resolve, reject) => {\n      if (!(\"PeripheralDeviceNotification\" in this.info.services)) {\n        resolve(null);\n        return;\n      }\n      this.write(\"CONFIRM_NOTIFY_CATEGORY\")\n        .then((res: any) => {\n          resolve(res);\n        })\n        .catch((error) => {\n          reject(error);\n        });\n    });\n    return promise;\n  }\n\n  public _writeGetSettingInformation() {\n    const promise = new Promise((resolve, reject) => {\n      if (!(\"PeripheralDeviceSettingOperation\" in this.info.services)) {\n        resolve(null);\n        return;\n      }\n      this.write(\"GET_SETTING_INFORMATION\")\n        .then((res: any) => {\n          resolve(res);\n        })\n        .catch((error: any) => {\n          reject(error);\n        });\n    });\n    return promise;\n  }\n\n  public _writeGetSettingName(name: string) {\n    const promise = new Promise((resolve, reject) => {\n      if (!(\"PeripheralDeviceSettingOperation\" in this.info.services)) {\n        resolve(null);\n        return;\n      }\n\n      const s = this.info.settings;\n      if (name === \"LEDColorName\") {\n        if (!(\"LED\" in s && s.LED.colorMax)) {\n          resolve(null);\n          return;\n        }\n      } else if (name === \"LEDPatternName\") {\n        if (!(\"LED\" in s && s.LED.patternMax)) {\n          resolve(null);\n          return;\n        }\n      } else if (name === \"VibrationPatternName\") {\n        if (!(\"Vibration\" in s && s.Vibration.patternMax)) {\n          resolve(null);\n          return;\n        }\n      } else if (name === \"BeepPatternName\") {\n        if (!(\"Beep\" in s && s.Beep.patternMax)) {\n          resolve(null);\n          return;\n        }\n      }\n      this.write(\"GET_SETTING_NAME\", { SettingNameType: name })\n        .then((res) => {\n          resolve(res);\n        })\n        .catch((error) => {\n          reject(error);\n        });\n    });\n    return promise;\n  }\n\n  public _isFunction(o: any) {\n    return o && typeof o === \"function\" ? true : false;\n  }\n\n  public _getServicesAndChars() {\n    const peripheral = this._peripheral;\n    const service = peripheral.getService(this.PRIMARY_SERVICE_UUID);\n    if (!service) {\n      throw new Error(\"No service was found\");\n    }\n    const write_char = service.getCharacteristic(this.WRITE_CHARACTERRISTIC_UUID);\n    const indicate_char = service.getCharacteristic(this.INDICATE_CHARACTERRISTIC_UUID);\n    if (!(write_char && indicate_char)) {\n      throw new Error(\"No characteristic was found\");\n    }\n    this.char_write = write_char;\n    this.char_indicate = indicate_char;\n    this._service = service;\n\n    const ga_service = peripheral.getService(this._generic_access_service.SERVICE_UUID);\n    if (ga_service) {\n      const ga_char = ga_service.getCharacteristic(this._generic_access_service.device_name.CHARACTERRISTIC_UUID);\n      if (ga_service && ga_char) {\n        this._generic_access_service.service = ga_service;\n        this._generic_access_service.device_name.char = ga_char;\n      }\n    }\n  }\n\n  public async _subscribeForIndicate() {\n    await this.char_indicate!.registerNotifyWait((data: number[]) => {\n      this._receivedPacket(Buffer.from(data));\n    });\n  }\n\n  public _receivedPacket(buf: any) {\n    const new_buf = Buffer.alloc(buf.length - 1);\n    buf.copy(new_buf, 0, 1, buf.length);\n    this._div_packet_queue.push(new_buf);\n    if (this._isExecutedPacket(buf)) {\n      const header_byte = Buffer.from([buf.readUInt8(0)]);\n      this._div_packet_queue.unshift(header_byte);\n      const total_buf = Buffer.concat(this._div_packet_queue);\n      this._receivedIndicate(total_buf);\n      this._div_packet_queue = [];\n    }\n  }\n\n  public _isExecutedPacket(buf: any) {\n    const ph = buf.readUInt8(0);\n    return ph & 0x00000001 ? true : false;\n  }\n\n  public _receivedIndicate(buf: any) {\n    const parsed = this._LinkingService.parseResponse(buf);\n    if (!parsed) {\n      return;\n    }\n    if (parsed.messageName.match(/_RESP$/)) {\n      if (this._onresponse) {\n        this._onresponse(parsed);\n      }\n    } else {\n      // All notifications\n      if (this._isFunction(this.onnotify)) {\n        this.onnotify(parsed);\n      }\n      // Button\n      if (parsed.serviceId === 2) {\n        // PeripheralDeviceOperation Service\n        if (parsed.messageId === 0) {\n          // NOTIFY_PD_OPERATION\n          // let f = this.services['button']['onnotify'];\n          let f = null;\n          if (this.services.button) {\n            if (this._isFunction(this.services.button.onnotify)) {\n              f = this.services.button.onnotify;\n            }\n          }\n          if (f) {\n            let button = null;\n            parsed.parameters.forEach((p: any) => {\n              if (p.parameterId === 2) {\n                // ButtonId\n                button = {\n                  buttonId: p.buttonId,\n                  buttonName: p.buttonName,\n                };\n              }\n            });\n            f(button);\n          }\n        }\n        // Sensors\n      } else if (parsed.serviceId === 3) {\n        // PeripheralDeviceSensorInformation Service\n        if (parsed.messageId === 4) {\n          // NOTIFY_PD_SENSOR_INFO\n          let sensor_type = -1;\n          let res: any = {};\n          parsed.parameters.forEach((p: any) => {\n            const pid = p.parameterId;\n            if (pid === 2) {\n              // SensorType\n              sensor_type = p.sensorTypeCode;\n            } else {\n              if (sensor_type.toString().match(/^(0|1|2)$/)) {\n                // Gyroscope, Accelerometer, Orientation\n                if (pid === 4) {\n                  // X_value\n                  res.x = p.xValue;\n                } else if (pid === 5) {\n                  // Y_value\n                  res.y = p.yValue;\n                } else if (pid === 6) {\n                  // Z_value\n                  res.z = p.zValue;\n                }\n              } else if (sensor_type === 3) {\n                // Battery\n                res = {\n                  charge: p.charge,\n                  level: p.level,\n                };\n              } else if (sensor_type === 4) {\n                // Temperature\n                res.temperature = p.temperature;\n              } else if (sensor_type === 5) {\n                // Humidity\n                res.humidity = p.humidity;\n              } else if (sensor_type === 6) {\n                // Aire pressure\n                res.pressure = p.pressure;\n              } else if (sensor_type === 7) {\n                // Opening and closing\n                res.openclose = p.openclose;\n              } else if (sensor_type === 8) {\n                // Human detection\n                res.human = p.human;\n              } else if (sensor_type === 9) {\n                // Move\n                res.move = p.move;\n              } else if (sensor_type === 0x0a) {\n                // Illuminance\n                res.illuminance = p.illuminance;\n              }\n            }\n          });\n\n          let f = null;\n          if (sensor_type === 0) {\n            if (this.services.gyroscope) {\n              f = this.services.gyroscope.onnotify;\n            }\n          } else if (sensor_type === 1) {\n            if (this.services.accelerometer) {\n              f = this.services.accelerometer.onnotify;\n            }\n          } else if (sensor_type === 2) {\n            if (this.services.orientation) {\n              f = this.services.orientation.onnotify;\n            }\n          } else if (sensor_type === 3) {\n            if (this.services.battery) {\n              f = this.services.battery.onnotify;\n            }\n          } else if (sensor_type === 4) {\n            if (this.services.temperature) {\n              f = this.services.temperature.onnotify;\n            }\n          } else if (sensor_type === 5) {\n            if (this.services.humidity) {\n              f = this.services.humidity.onnotify;\n            }\n          } else if (sensor_type === 6) {\n            if (this.services.pressure) {\n              f = this.services.pressure.onnotify;\n            }\n          } else if (sensor_type === 7) {\n            if (this.services.openclose) {\n              f = this.services.openclose.onnotify;\n            }\n          } else if (sensor_type === 8) {\n            if (this.services.human) {\n              f = this.services.human.onnotify;\n            }\n          } else if (sensor_type === 9) {\n            if (this.services.move) {\n              f = this.services.move.onnotify;\n            }\n          } else if (sensor_type === 0x0a) {\n            if (this.services.illuminance) {\n              f = this.services.illuminance.onnotify;\n            }\n          }\n\n          if (this._isFunction(f)) {\n            f(res);\n          }\n        }\n      }\n    }\n  }\n\n  public async disconnect() {\n    if (this.connected === false) {\n      await this._clean();\n      return;\n    }\n    await this._peripheral.disconnectWait();\n    if (this._isFunction(this.ondisconnect)) {\n      this.ondisconnect({ wasClean: true });\n    }\n  }\n\n  public async _clean() {\n    const p = this._peripheral;\n    if (!p) {\n      return;\n    }\n    if (this.char_indicate) {\n      await this.char_indicate.unregisterNotifyWait();\n    }\n    // p.removeAllListeners();\n    this.connected = false;\n    this._service = null;\n    this.char_write = null;\n    this.char_indicate = null;\n    this._div_packet_queue = [];\n    this._onresponse = null;\n  }\n\n  public write(message_name: any, params?: any) {\n    return new Promise(async (resolve, reject) => {\n      const buf = this._LinkingService.createRequest(message_name, params);\n      if (!buf) {\n        reject(new Error(\"The specified parameters are invalid.\"));\n      }\n\n      const timer = setTimeout(() => {\n        this._onresponse = null;\n        reject(new Error(\"Timeout\"));\n      }, this._write_response_timeout);\n\n      this._onresponse = (res: any) => {\n        if (res.messageName === message_name + \"_RESP\") {\n          this._onresponse = null;\n          clearTimeout(timer);\n          const data = this._margeResponsePrameters(res);\n          if (data) {\n            res.data = data;\n            resolve(res);\n          } else {\n            reject(new Error(\"Unknown response\"));\n          }\n        }\n      };\n\n      try {\n        await this.char_write!.writeWait(buf, true);\n      } catch (e) {\n        reject(e);\n      }\n    });\n  }\n\n  public _margeResponsePrameters(res: any) {\n    if (!res) {\n      return null;\n    }\n    const parameters = res.parameters;\n    if (parameters && Array.isArray(parameters) && parameters.length > 0) {\n      const data: any = {};\n      parameters.forEach((p) => {\n        for (const k in p) {\n          if (!k.match(/^(name|parameterId)$/)) {\n            data[k] = p[k];\n          }\n        }\n      });\n      return data;\n    } else {\n      return null;\n    }\n  }\n\n  public _initServices() {\n    const device_name = this._peripheral.localName || \"\";\n    // Device Name\n    if (this._generic_access_service.device_name.char) {\n      this.services.deviceName = {\n        get: this._deviceNameGet.bind(this),\n        set: this._deviceNameSet.bind(this),\n      };\n    }\n    // Button\n    if (\"Button\" in this.info.exsensors || device_name.match(/^(Linking Board01|BLEAD\\-LK\\-TSH)/)) {\n      this.services.button = {\n        onnotify: null,\n      };\n    }\n    // LED\n    if (\"LED\" in this.info.settings) {\n      const o = this.info.settings.LED;\n      if (o.colors && o.colors.length > 0 && o.patterns && o.patterns.length > 0) {\n        const colors: any = {};\n        for (let i = 0; i < o.colors.length; i++) {\n          colors[o.colors[i]] = i + 1;\n        }\n        const patterns: any = {};\n        for (let i = 0; i < o.patterns.length; i++) {\n          patterns[o.patterns[i]] = i + 1;\n        }\n        this.services.led = {\n          colors,\n          patterns,\n          turnOn: this._ledTurnOn.bind(this),\n          turnOff: this._ledTurnOff.bind(this),\n        };\n      }\n    }\n    // Vibration\n    if (\"Vibration\" in this.info.settings) {\n      const o = this.info.settings.Vibration;\n      if (o.patterns && o.patterns.length > 0) {\n        const patterns: any = {};\n        for (let i = 0; i < o.patterns.length; i++) {\n          patterns[o.patterns[i]] = i + 1;\n        }\n        this.services.vibration = {\n          patterns,\n          turnOn: this._vibrationTurnOn.bind(this),\n          turnOff: this._vibrationTurnOff.bind(this),\n        };\n      }\n    }\n    // Gyroscope\n    if (\"Gyroscope\" in this.info.capabilities) {\n      this.services.gyroscope = this._createSensorServiceObject(0x00);\n    }\n    // Accelerometer\n    if (\"Accelerometer\" in this.info.capabilities) {\n      this.services.accelerometer = this._createSensorServiceObject(0x01);\n    }\n    // Orientation\n    if (\"Orientation\" in this.info.capabilities) {\n      this.services.orientation = this._createSensorServiceObject(0x02);\n    }\n    // Battery\n    if (\"Battery\" in this.info.capabilities) {\n      this.services.battery = this._createSensorServiceObject(0x03);\n    }\n    // Temperature\n    if (\"Temperature\" in this.info.capabilities) {\n      this.services.temperature = this._createSensorServiceObject(0x04);\n    }\n    // Humidity\n    if (\"Humidity\" in this.info.capabilities) {\n      this.services.humidity = this._createSensorServiceObject(0x05);\n    }\n    // Atmospheric pressure\n    if (\"Atmospheric pressure\" in this.info.capabilities) {\n      this.services.pressure = this._createSensorServiceObject(0x06);\n    }\n    // Opening and closing\n    if (\"Opening and closing\" in this.info.exsensors) {\n      this.services.openclose = this._createSensorServiceObject(0x07);\n    }\n    // Human detection\n    if (\"Human detection\" in this.info.exsensors) {\n      this.services.human = this._createSensorServiceObject(0x08);\n    }\n    // Move\n    if (\"Move\" in this.info.exsensors) {\n      this.services.move = this._createSensorServiceObject(0x09);\n    }\n    // Illuminance\n    if (\"Illuminance\" in this.info.exsensors) {\n      this.services.illuminance = this._createSensorServiceObject(0x0a);\n    }\n  }\n\n  public _deviceNameGet() {\n    const promise = new Promise((resolve, reject) => {\n      const char = this._generic_access_service.device_name.char;\n      char.read((error: any, data: any) => {\n        if (error) {\n          reject(error);\n        } else {\n          resolve({\n            deviceName: data.toString(\"utf8\"),\n          });\n        }\n      });\n    });\n    return promise;\n  }\n\n  public _deviceNameSet(name: string) {\n    const promise = new Promise((resolve, reject) => {\n      if (!name) {\n        reject(new Error(\"Device name is required.\"));\n        return;\n      } else if (typeof name !== \"string\") {\n        reject(new Error(\"Device name must be a string.\"));\n        return;\n      } else if (name.length > 32) {\n        reject(new Error(\"Device name is too long. The length must be in the range 1 to 32.\"));\n        return;\n      }\n      const buf = Buffer.from(name, \"utf8\");\n      const char = this._generic_access_service.device_name.char;\n      char.write(buf, false, (error: any) => {\n        if (error) {\n          reject(error);\n        } else {\n          resolve();\n        }\n      });\n    });\n    return promise;\n  }\n\n  public _ledTurnOn(color: any, pattern: any, duration: any) {\n    let color_number = 1;\n    if (color) {\n      const colors = this.services.led.colors;\n      if (typeof color === \"number\") {\n        for (const name in colors) {\n          if (colors[name] === color) {\n            color_number = color;\n            break;\n          }\n        }\n      } else if (typeof color === \"string\") {\n        if (color in colors) {\n          color_number = colors[color];\n        }\n      }\n    }\n    let pattern_number = 2;\n    if (pattern) {\n      const patterns = this.services.led.patterns;\n      if (typeof pattern === \"number\") {\n        for (const name in patterns) {\n          if (patterns[name] === pattern) {\n            pattern_number = pattern;\n            break;\n          }\n        }\n      } else if (typeof pattern === \"string\") {\n        if (pattern in patterns) {\n          pattern_number = patterns[pattern];\n        }\n      }\n    }\n    if (!duration || typeof duration !== \"number\" || duration % 1 !== 0) {\n      duration = 5;\n    }\n    const promise = new Promise((resolve, reject) => {\n      this.write(\"SELECT_SETTING_INFORMATION\", {\n        SettingInformationRequest: {\n          requestName: \"START_DEMONSTRATION\",\n        },\n        SettingInformationData: [\n          {\n            settingName: \"LED\",\n            colorNumber: color_number,\n            patternNumber: pattern_number,\n            duration,\n          },\n        ],\n      })\n        .then((res: any) => {\n          resolve(res.data);\n        })\n        .catch((error) => {\n          reject(error);\n        });\n    });\n    return promise;\n  }\n\n  public _ledTurnOff() {\n    const promise = new Promise((resolve, reject) => {\n      this.write(\"SELECT_SETTING_INFORMATION\", {\n        SettingInformationRequest: {\n          requestName: \"STOP_DEMONSTRATION\",\n        },\n      })\n        .then((res: any) => {\n          resolve(res.data);\n        })\n        .catch((error) => {\n          reject(error);\n        });\n    });\n    return promise;\n  }\n\n  public _vibrationTurnOn(pattern: any, duration: any) {\n    let pattern_number = 2;\n    if (pattern) {\n      const patterns = this.services.vibration.patterns;\n      if (typeof pattern === \"number\") {\n        for (const name in patterns) {\n          if (patterns[name] === pattern) {\n            pattern_number = pattern;\n            break;\n          }\n        }\n      } else if (typeof pattern === \"string\") {\n        if (pattern in patterns) {\n          pattern_number = patterns[pattern];\n        }\n      }\n    }\n    if (!duration || typeof duration !== \"number\" || duration % 1 !== 0) {\n      duration = 5;\n    }\n    const promise = new Promise((resolve, reject) => {\n      this.write(\"SELECT_SETTING_INFORMATION\", {\n        SettingInformationRequest: {\n          requestName: \"START_DEMONSTRATION\",\n        },\n        SettingInformationData: [\n          {\n            settingName: \"Vibration\",\n            patternNumber: pattern_number,\n            duration,\n          },\n        ],\n      })\n        .then((res: any) => {\n          resolve(res.data);\n        })\n        .catch((error) => {\n          reject(error);\n        });\n    });\n    return promise;\n  }\n\n  public _vibrationTurnOff() {\n    const promise = new Promise((resolve, reject) => {\n      this.write(\"SELECT_SETTING_INFORMATION\", {\n        SettingInformationRequest: {\n          requestName: \"STOP_DEMONSTRATION\",\n        },\n      })\n        .then((res: any) => {\n          resolve(res.data);\n        })\n        .catch((error) => {\n          reject(error);\n        });\n    });\n    return promise;\n  }\n\n  public _createSensorServiceObject(sensor_type: any) {\n    return {\n      onnotify: null,\n      start: () => {\n        return this._setNotifySensorInfo(sensor_type, 1);\n      },\n      stop: () => {\n        return this._setNotifySensorInfo(sensor_type, 0);\n      },\n      get: () => {\n        return this._getSensorInfo(sensor_type);\n      },\n    };\n  }\n\n  public _setNotifySensorInfo(sensor_type: any, status: any) {\n    const promise = new Promise((resolve, reject) => {\n      this.write(\"SET_NOTIFY_SENSOR_INFO\", {\n        SensorType: sensor_type,\n        Status: status,\n      })\n        .then((res: any) => {\n          resolve(res.data);\n        })\n        .catch((error) => {\n          reject(error);\n        });\n    });\n    return promise;\n  }\n\n  public _getSensorInfo(sensor_type: any) {\n    const promise = new Promise((resolve, reject) => {\n      this.write(\"GET_SENSOR_INFO\", {\n        SensorType: sensor_type,\n      })\n        .then((res: any) => {\n          if (sensor_type.toString().match(/^(0|1|2)$/)) {\n            // Gyroscope, Accelerometer, Orientation\n            const d = res.data;\n            const data = {\n              x: d.xValue,\n              y: d.yValue,\n              z: d.zValue,\n            };\n            resolve(data);\n          } else {\n            resolve(res.data);\n          }\n        })\n        .catch((error) => {\n          reject(error);\n        });\n    });\n    return promise;\n  }\n}\n"]}