{"version":3,"sources":["../src/parts/Ble/linking/index.ts"],"names":[],"mappings":"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","file":"index.js","sourcesContent":["/**\n * @packageDocumentation\n * @module Parts.Linking\n */\n\n/* ------------------------------------------------------------------\n * node-linking - linking.js\n *\n * Copyright (c) 2017-2019, Futomi Hatano, All rights reserved.\n * Released under the MIT license\n * Date: 2019-10-24\n * ---------------------------------------------------------------- */\n\nimport Obniz from \"../../../obniz\";\nimport bleRemotePeripheral from \"../../../obniz/libs/embeds/bleHci/bleRemotePeripheral\";\nimport { ObnizPartsInfo } from \"../../../obniz/ObnizPartsInterface\";\n\nimport LinkingAdvertising from \"./modules/advertising\";\nimport LinkingDevice from \"./modules/device\";\n\nexport interface LinkingOptions {}\n\nexport default class Linking {\n  public static info(): ObnizPartsInfo {\n    return {\n      name: \"Linking\",\n    };\n  }\n\n  public onadvertisement: any;\n  public ondiscover: any;\n  public PRIMARY_SERVICE_UUID_LIST = [\"b3b3690150d34044808d50835b13a6cd\", \"fe4e\"];\n  public _discover_status: any;\n  public _discover_wait: any;\n  public _discover_timer: any;\n  public _peripherals: any;\n  public initialized = false;\n\n  public keys: string[];\n  public requiredKeys: string[];\n  public periperal: bleRemotePeripheral | null;\n  public obniz!: Obniz;\n\n  constructor(params: any) {\n    this.keys = [];\n    this.requiredKeys = [];\n    this.periperal = null;\n\n    this.onadvertisement = null;\n    this.ondiscover = null;\n\n    // Private properties\n    this._discover_status = false;\n    this._discover_wait = 3000; // ms\n    this._discover_timer = null;\n    this._peripherals = {};\n  }\n\n  public wired(obniz: Obniz) {\n    this.obniz = obniz;\n  }\n\n  public async init() {\n    await this.obniz.ble!.initWait();\n    this.initialized = true;\n  }\n\n  public discover(p: any): Promise<any[]> {\n    this._checkInitialized();\n\n    let duration = 5000;\n    let name_filter = \"\";\n    let id_filter = \"\";\n    let quick = false;\n    if (p && typeof p === \"object\") {\n      if (\"duration\" in p && typeof p.duration === \"number\") {\n        duration = p.duration;\n        if (duration < 1000) {\n          duration = 1000;\n        }\n      }\n      if (\"nameFilter\" in p && typeof (p.nameFilter === \"string\")) {\n        name_filter = p.nameFilter;\n      }\n      if (\"idFilter\" in p && typeof (p.idFilter === \"string\")) {\n        id_filter = p.idFilter;\n      }\n      if (\"quick\" in p && typeof (p.quick === \"boolean\")) {\n        quick = p.quick;\n      }\n    }\n\n    return new Promise((resolve, reject) => {\n      let timer: any = null;\n      const finishDiscovery = () => {\n        if (timer) {\n          clearTimeout(timer);\n        }\n        this.stopScan();\n        const device_list = [];\n        for (const addr in this._peripherals) {\n          device_list.push(this._peripherals[addr]);\n        }\n        resolve(device_list);\n      };\n      this._peripherals = {};\n      this.obniz.ble!.scan.onfind = (peripheral: bleRemotePeripheral) => {\n        const dev = this._discoveredDevice(peripheral, name_filter, id_filter);\n        if (quick && dev) {\n          finishDiscovery();\n          return;\n        }\n      };\n      this._scanDevices();\n      this._discover_status = true;\n      timer = setTimeout(() => {\n        finishDiscovery();\n      }, duration);\n    });\n  }\n\n  public _checkInitialized() {\n    if (this.initialized === false) {\n      throw new Error(\"The `init()` method has not been called yet.\");\n      return;\n    }\n    if (this._discover_status === true) {\n      throw new Error(\"The `discover()` or the `startScan()` method is in progress.\");\n      return;\n    }\n  }\n\n  public _discoveredDevice(peripheral: bleRemotePeripheral, name_filter: any, id_filter: any) {\n    if (!peripheral.localName) {\n      return null;\n    }\n    // if (!peripheral.id) {\n    //   return null;\n    // }\n    if (name_filter && peripheral.localName.indexOf(name_filter) !== 0) {\n      return null;\n    }\n    // if (id_filter && peripheral.id.indexOf(id_filter) !== 0) {\n    //   return null;\n    // }\n    const addr = peripheral.address;\n    if (this._peripherals[addr]) {\n      return null;\n    }\n    const device = new LinkingDevice(peripheral);\n    if (this.ondiscover && typeof this.ondiscover === \"function\") {\n      this.ondiscover(device);\n    }\n    this._peripherals[addr] = device;\n    return device;\n  }\n\n  public _scanDevices() {\n    this.obniz.ble!.scan.onfinish = () => {\n      // console.log(\"scan timeout!\")\n      this._discover_status = false;\n    };\n    // var target = {\n    //   uuids: this.PRIMARY_SERVICE_UUID_LIST\n    // };\n    this.obniz.ble!.scan.start();\n    this._discover_status = true;\n  }\n\n  public stopScan() {\n    if (this._discover_status === true) {\n      this._discover_status = false;\n      if (this._discover_timer !== null) {\n        clearTimeout(this._discover_timer);\n        this._discover_timer = null;\n      }\n      this.obniz.ble!.scan.end();\n    }\n  }\n\n  public startScan(p: any) {\n    this._checkInitialized();\n    let name_filter = \"\";\n    let id_filter = \"\";\n    if (p && typeof p === \"object\") {\n      if (\"nameFilter\" in p && typeof (p.nameFilter === \"string\")) {\n        name_filter = p.nameFilter;\n      }\n      if (\"idFilter\" in p && typeof (p.idFilter === \"string\")) {\n        id_filter = p.idFilter;\n      }\n    }\n\n    this.obniz.ble!.scan.onfind = (peripheral: bleRemotePeripheral) => {\n      if (!peripheral.localName) {\n        return;\n      }\n      if (name_filter && peripheral.localName.indexOf(name_filter) !== 0) {\n        return;\n      }\n      // TODO\n      // if (id_filter && peripheral.id.indexOf(id_filter) !== 0) {\n      //   return;\n      // }\n      if (typeof this.onadvertisement === \"function\") {\n        const parsed = LinkingAdvertising.parse(peripheral);\n        if (parsed) {\n          this.onadvertisement(parsed);\n        }\n      }\n    };\n\n    this._scanDevices();\n  }\n}\n"]}