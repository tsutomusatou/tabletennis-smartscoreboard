{"version":3,"sources":["../src/parts/Ble/2jcie/index.ts"],"names":[],"mappings":"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","file":"index.js","sourcesContent":["/**\n * @packageDocumentation\n * @module Parts.OMRON_2JCIE\n */\n\nimport Obniz from \"../../../obniz\";\nimport bleRemoteCharacteristic from \"../../../obniz/libs/embeds/bleHci/bleRemoteCharacteristic\";\nimport BleRemotePeripheral from \"../../../obniz/libs/embeds/bleHci/bleRemotePeripheral\";\nimport ObnizPartsBleInterface from \"../../../obniz/ObnizPartsBleInterface\";\nimport ObnizPartsInterface, { ObnizPartsInfo } from \"../../../obniz/ObnizPartsInterface\";\n\nexport interface OMRON_2JCIEOptions {}\n\nexport interface OMRON_2JCIE_Data {\n  row_number: number;\n  temperature: number;\n  relative_humidity: number;\n  light: number;\n  uv_index: number;\n  barometric_pressure: number;\n  soud_noise: number;\n  discomfort_index: number;\n  heatstroke_risk_factor: number;\n  battery_voltage: number;\n}\n\nexport interface OMRON_2JCIE_AdvData {\n  temperature: number;\n  relative_humidity: number;\n  light: number;\n  uv_index: number;\n  barometric_pressure: number;\n  soud_noise: number;\n}\n\nexport default class OMRON_2JCIE implements ObnizPartsBleInterface {\n  public static info(): ObnizPartsInfo {\n    return {\n      name: \"2JCIE\",\n    };\n  }\n\n  public static isDevice(peripheral: BleRemotePeripheral) {\n    return (\n      (peripheral.localName && peripheral.localName.indexOf(\"Env\") >= 0) ||\n      (peripheral.localName && peripheral.localName.indexOf(\"IM\") >= 0)\n    );\n  }\n\n  /**\n   * Get a datas from advertisement mode of OMRON 2JCIE\n   */\n  public static getData(peripheral: BleRemotePeripheral): OMRON_2JCIE_AdvData | null {\n    if (peripheral.localName && peripheral.localName.indexOf(\"IM\") >= 0) {\n      const adv_data = peripheral.adv_data;\n      return {\n        temperature: ObnizPartsBleInterface.signed16FromBinary(adv_data[8], adv_data[9]) * 0.01,\n        relative_humidity: ObnizPartsBleInterface.signed16FromBinary(adv_data[10], adv_data[11]) * 0.01,\n        light: ObnizPartsBleInterface.signed16FromBinary(adv_data[12], adv_data[13]) * 1,\n        uv_index: ObnizPartsBleInterface.signed16FromBinary(adv_data[14], adv_data[15]) * 0.01,\n        barometric_pressure: ObnizPartsBleInterface.signed16FromBinary(adv_data[16], adv_data[17]) * 0.1,\n        soud_noise: ObnizPartsBleInterface.signed16FromBinary(adv_data[18], adv_data[18]) * 0.01,\n      };\n    }\n    return null;\n  }\n\n  public _peripheral: BleRemotePeripheral | null = null;\n  public obniz!: Obniz;\n  public params: any;\n  public ondisconnect?: (reason: any) => void;\n\n  constructor(peripheral: BleRemotePeripheral | null) {\n    if (peripheral && !OMRON_2JCIE.isDevice(peripheral)) {\n      throw new Error(\"peripheral is not RS_BTIREX2\");\n    }\n    this._peripheral = peripheral;\n  }\n\n  public wired(obniz: Obniz) {\n    this.obniz = obniz;\n  }\n\n  public async findWait(): Promise<any> {\n    const target: any = {\n      localName: \"Env\",\n    };\n\n    await this.obniz.ble!.initWait();\n    this._peripheral = await this.obniz.ble!.scan.startOneWait(target);\n\n    return this._peripheral;\n  }\n\n  public omron_uuid(uuid: string): string {\n    return `0C4C${uuid}-7700-46F4-AA96D5E974E32A54`;\n  }\n\n  public async connectWait() {\n    if (!this._peripheral) {\n      await this.findWait();\n    }\n    if (!this._peripheral) {\n      throw new Error(\"2JCIE not found\");\n    }\n    if (!this._peripheral.connected) {\n      this._peripheral.ondisconnect = (reason: any) => {\n        if (typeof this.ondisconnect === \"function\") {\n          this.ondisconnect(reason);\n        }\n      };\n      await this._peripheral.connectWait();\n    }\n  }\n\n  public async disconnectWait() {\n    if (this._peripheral && this._peripheral.connected) {\n      await this._peripheral.disconnectWait();\n    }\n  }\n\n  public signedNumberFromBinary(data: number[]) {\n    // little adian\n    let val: number = data[data.length - 1] & 0x7f;\n    for (let i = data.length - 2; i >= 0; i--) {\n      val = val * 256 + data[i];\n    }\n    if ((data[data.length - 1] & 0x80) !== 0) {\n      val = val - Math.pow(2, data.length * 8 - 1);\n    }\n    return val;\n  }\n\n  public unsignedNumberFromBinary(data: number[]) {\n    // little adian\n    let val: number = data[data.length - 1];\n    for (let i = data.length - 2; i >= 0; i--) {\n      val = val * 256 + data[i];\n    }\n    return val;\n  }\n\n  public async getLatestData(): Promise<OMRON_2JCIE_Data> {\n    await this.connectWait();\n\n    const c = this._peripheral!.getService(this.omron_uuid(\"3000\"))!.getCharacteristic(this.omron_uuid(\"3001\"))!;\n    const data: number[] = await c.readWait();\n    const json: any = {\n      row_number: data[0],\n      temperature: this.signedNumberFromBinary(data.slice(1, 3)) * 0.01,\n      relative_humidity: this.signedNumberFromBinary(data.slice(3, 5)) * 0.01,\n      light: this.signedNumberFromBinary(data.slice(5, 7)) * 1,\n      uv_index: this.signedNumberFromBinary(data.slice(7, 9)) * 0.01,\n      barometric_pressure: this.signedNumberFromBinary(data.slice(9, 11)) * 0.1,\n      soud_noise: this.signedNumberFromBinary(data.slice(11, 13)) * 0.01,\n      discomfort_index: this.signedNumberFromBinary(data.slice(13, 15)) * 0.01,\n      heatstroke_risk_factor: this.signedNumberFromBinary(data.slice(15, 17)) * 0.01,\n      battery_voltage: this.unsignedNumberFromBinary(data.slice(17, 19)) * 0.001,\n    };\n\n    return json;\n  }\n}\n"]}