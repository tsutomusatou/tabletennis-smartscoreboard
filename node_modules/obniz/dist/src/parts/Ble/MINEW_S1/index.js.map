{"version":3,"sources":["../src/parts/Ble/MINEW_S1/index.ts"],"names":[],"mappings":"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","file":"index.js","sourcesContent":["/**\n * @packageDocumentation\n * @module Parts.MINEW_S1_HT\n */\n\nimport Obniz from \"../../../obniz\";\nimport BleRemotePeripheral from \"../../../obniz/libs/embeds/bleHci/bleRemotePeripheral\";\nimport ObnizUtil from \"../../../obniz/libs/utils/util\";\nimport ObnizPartsBleInterface from \"../../../obniz/ObnizPartsBleInterface\";\nimport ObnizPartsInterface, { ObnizPartsInfo } from \"../../../obniz/ObnizPartsInterface\";\n\nexport interface MINEW_S1_HTData {\n  frameType: number;\n  versionNumber: number;\n  batteryLevel: number;\n  temperature: number;\n  humidity: number;\n  macAddress: string;\n}\n\nexport interface MINEW_S1_InfoData {\n  frameType: number;\n  versionNumber: number;\n  batteryLevel: number;\n  macAddress: string;\n  name: string;\n}\n\nexport interface MINEW_S1Options {}\n\nexport default class MINEW_S1 implements ObnizPartsBleInterface {\n  public static info() {\n    return { name: \"MINEW_S1\" };\n  }\n\n  public static isDevice(peripheral: BleRemotePeripheral, macAddress: string | null = null): boolean {\n    if (!this._hasPrefix(peripheral)) {\n      return false;\n    }\n    if (macAddress) {\n      const data = this.getInfoData(peripheral) || this.getHTData(peripheral);\n      if (data && data.macAddress === macAddress) {\n        return true;\n      }\n      return false;\n    }\n    return true;\n  }\n\n  public static getInfoData(peripheral: BleRemotePeripheral): null | MINEW_S1_InfoData {\n    if (!this._hasPrefix(peripheral)) {\n      return null;\n    }\n    if (!peripheral.adv_data || peripheral.adv_data.length < 20) {\n      return null;\n    }\n    const frameType = peripheral.adv_data[11];\n    const versionNumber = peripheral.adv_data[12];\n    if (frameType !== 0xa1 || versionNumber !== 0x08) {\n      return null;\n    }\n\n    const batteryLevel = peripheral.adv_data[13];\n    const macAddress = peripheral.adv_data\n      .slice(14, 20)\n      .map((e: number) => (\"0\" + e.toString(16)).slice(-2))\n      .join(\"\")\n      .match(/.{1,2}/g)!\n      .reverse()\n      .join(\"\");\n\n    const name = ObnizUtil.dataArray2string(peripheral.adv_data.slice(20)) as string;\n\n    return {\n      frameType,\n      versionNumber,\n      batteryLevel,\n      name,\n      macAddress,\n    };\n  }\n\n  public static getHTData(peripheral: BleRemotePeripheral): null | MINEW_S1_HTData {\n    if (!this._hasPrefix(peripheral)) {\n      return null;\n    }\n    if (!peripheral.adv_data || peripheral.adv_data.length !== 24) {\n      return null;\n    }\n    const frameType = peripheral.adv_data[11];\n    const versionNumber = peripheral.adv_data[12];\n    if (frameType !== 0xa1 || versionNumber !== 0x01) {\n      return null;\n    }\n\n    const batteryLevel = peripheral.adv_data[13];\n    const temperatureH = peripheral.adv_data[14];\n    const temperatureL = peripheral.adv_data[15];\n    const temperature = temperatureH + (temperatureL * 1) / (1 << 8);\n    const humidityH = peripheral.adv_data[16];\n    const humidityL = peripheral.adv_data[17];\n    const humidity = humidityH + (humidityL * 1) / (1 << 8);\n\n    const macAddress = peripheral.adv_data\n      .splice(18)\n      .map((e: number) => (\"0\" + e.toString(16)).slice(-2))\n      .join(\"\")\n      .match(/.{1,2}/g)!\n      .reverse()\n      .join(\"\");\n\n    return {\n      frameType,\n      versionNumber,\n      batteryLevel,\n      temperature,\n      humidity,\n      macAddress,\n    };\n  }\n\n  private static _hasPrefix(peripheral: BleRemotePeripheral): boolean {\n    if (!peripheral.adv_data || peripheral.adv_data.length < 10) {\n      return false;\n    }\n    const target = [\n      // flag\n      0x02,\n      0x01,\n      0x06,\n      // 16bit uuid\n      0x03,\n      0x03,\n      0xe1,\n      0xff,\n      // service data\n      -1,\n      0x16,\n      0xe1,\n      0xff,\n    ];\n    for (const index in target) {\n      if (target[index] >= 0 && target[index] !== peripheral.adv_data[index]) {\n        return false;\n      }\n    }\n    return true;\n  }\n\n  public _peripheral: null | BleRemotePeripheral = null;\n\n  // non-wired device\n  public keys: string[] = [];\n  public requiredKeys: string[] = [];\n  public params: any = {};\n\n  public wired(obniz: Obniz): void {}\n}\n"]}