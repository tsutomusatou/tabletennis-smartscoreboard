{"version":3,"sources":["../src/parts/Ble/LogttaCO2/index.ts"],"names":[],"mappings":"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","file":"index.js","sourcesContent":["/**\n * @packageDocumentation\n * @module Parts.Logtta_CO2\n */\n\nimport BleRemotePeripheral from \"../../../obniz/libs/embeds/bleHci/bleRemotePeripheral\";\nimport ObnizPartsBleInterface, { ObnizPartsBleInfo } from \"../../../obniz/ObnizPartsBleInterface\";\nimport BleBatteryService from \"../abstract/services/batteryService\";\nimport BleGenericAccess from \"../abstract/services/genericAccess\";\nexport interface Logtta_CO2Options {}\n\nexport interface Logtta_CO2_Adv_Data {\n  co2: number;\n  battery: number;\n  interval: number;\n  address: string;\n}\n\nexport default class Logtta_CO2 implements ObnizPartsBleInterface {\n  public static info(): ObnizPartsBleInfo {\n    return {\n      name: \"Logtta_CO2\",\n    };\n  }\n\n  public static isDevice(peripheral: BleRemotePeripheral) {\n    return peripheral.localName === \"CO2 Sensor\";\n  }\n\n  public static isAdvDevice(peripheral: BleRemotePeripheral) {\n    if (peripheral.adv_data.length !== 31) {\n      return false;\n    }\n    const data = peripheral.adv_data;\n    if (Logtta_CO2.getName(data) !== \"CO2 Sensor\") {\n      return false;\n    }\n    return true;\n  }\n\n  public static getData(peripheral: BleRemotePeripheral): Logtta_CO2_Adv_Data | null {\n    if (peripheral.adv_data.length !== 31) {\n      return null;\n    }\n    const data: number[] = peripheral.adv_data;\n    if (Logtta_CO2.getName(data) !== \"CO2 Sensor\") {\n      return null;\n    }\n    const alert: number = data[15];\n    const interval: number = (data[13] << 8) | data[14];\n    const advData: Logtta_CO2_Adv_Data = {\n      battery: data[12],\n      co2: (data[8] << 8) | data[9],\n      interval,\n      address: peripheral.address,\n    };\n    return advData;\n  }\n\n  private static getName(data: number[]) {\n    let name: string = \"\";\n    for (let i = 16; i < data.length; i++) {\n      if (data[i] === 0) {\n        break;\n      }\n      name += String.fromCharCode(data[i]);\n    }\n    return name;\n  }\n\n  private static get_uuid(uuid: string): string {\n    return `31f3${uuid}-bd1c-46b1-91e4-f57abcf7d449`;\n  }\n\n  public onNotify?: (co2: number) => void;\n  public _peripheral: BleRemotePeripheral | null;\n  public ondisconnect?: (reason: any) => void;\n  public genericAccess?: BleGenericAccess;\n  public batteryService?: BleBatteryService;\n\n  constructor(peripheral: BleRemotePeripheral | null) {\n    if (!peripheral || !Logtta_CO2.isDevice(peripheral)) {\n      throw new Error(\"peripheral is not Logtta CO2\");\n    }\n    this._peripheral = peripheral;\n  }\n\n  public async connectWait() {\n    if (!this._peripheral) {\n      throw new Error(\"Logtta CO2 not found\");\n    }\n    if (!this._peripheral.connected) {\n      this._peripheral.ondisconnect = (reason: any) => {\n        if (typeof this.ondisconnect === \"function\") {\n          this.ondisconnect(reason);\n        }\n      };\n      await this._peripheral.connectWait();\n\n      const service1800 = this._peripheral.getService(\"1800\");\n      if (service1800) {\n        this.genericAccess = new BleGenericAccess(service1800);\n      }\n      const service180F = this._peripheral.getService(\"180F\");\n      if (service180F) {\n        this.batteryService = new BleBatteryService(service180F);\n      }\n    }\n  }\n\n  public async disconnectWait() {\n    if (this._peripheral && this._peripheral.connected) {\n      await this._peripheral.disconnectWait();\n    }\n  }\n\n  public async getWait(): Promise<number | null> {\n    if (!(this._peripheral && this._peripheral.connected)) {\n      return null;\n    }\n\n    const c = this._peripheral!.getService(Logtta_CO2.get_uuid(\"AB20\"))!.getCharacteristic(Logtta_CO2.get_uuid(\"AB21\"));\n    const data: number[] = await c!.readWait();\n    return data[0] * 256 + data[1];\n  }\n\n  public async startNotifyWait() {\n    if (!(this._peripheral && this._peripheral.connected)) {\n      return;\n    }\n\n    const c = this._peripheral!.getService(Logtta_CO2.get_uuid(\"AB20\"))!.getCharacteristic(Logtta_CO2.get_uuid(\"AB21\"));\n\n    await c!.registerNotifyWait((data: number[]) => {\n      if (this.onNotify) {\n        this.onNotify(data[0] * 256 + data[1]);\n      }\n    });\n  }\n\n  public async authPinCodeWait(code: string) {\n    if (!(this._peripheral && this._peripheral.connected)) {\n      return;\n    }\n\n    if (code.length !== 4) {\n      throw new Error(\"Invalid length auth code\");\n    }\n\n    const data: [number] = [0];\n    for (let i = 0; i < code.length; i += 2) {\n      data.push((this.checkNumber(code.charAt(i)) << 4) | this.checkNumber(code.charAt(i + 1)));\n    }\n    const c = this._peripheral!.getService(Logtta_CO2.get_uuid(\"AB20\"))!.getCharacteristic(Logtta_CO2.get_uuid(\"AB30\"));\n    await c!.writeWait(data);\n  }\n\n  // 有効にしたあと、切断するとビーコンが発信される\n  public async setBeaconMode(enable: boolean) {\n    if (!(this._peripheral && this._peripheral.connected)) {\n      return;\n    }\n\n    const c = this._peripheral!.getService(Logtta_CO2.get_uuid(\"AB20\"))!.getCharacteristic(Logtta_CO2.get_uuid(\"AB2D\"));\n    if (enable) {\n      await c!.writeWait([1]);\n    } else {\n      await c!.writeWait([0]);\n    }\n  }\n\n  private checkNumber(data: string) {\n    if (data >= \"0\" && data <= \"9\") {\n      return parseInt(data, 10);\n    } else {\n      throw new Error(`authorization code can only be entered from 0-9.input word : ${data}`);\n    }\n  }\n}\n"]}