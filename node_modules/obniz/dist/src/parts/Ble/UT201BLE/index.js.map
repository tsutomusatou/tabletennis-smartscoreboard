{"version":3,"sources":["../src/parts/Ble/UT201BLE/index.ts"],"names":[],"mappings":"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","file":"index.js","sourcesContent":["/**\n * @packageDocumentation\n * @module Parts.UT201BLE\n */\n\nimport BleRemoteCharacteristic from \"../../../obniz/libs/embeds/bleHci/bleRemoteCharacteristic\";\nimport BleRemotePeripheral from \"../../../obniz/libs/embeds/bleHci/bleRemotePeripheral\";\nimport ObnizPartsBleInterface, { ObnizPartsBleInfo } from \"../../../obniz/ObnizPartsBleInterface\";\nimport BleBatteryService from \"../abstract/services/batteryService\";\nimport BleGenericAccess from \"../abstract/services/genericAccess\";\n\nexport interface UT201BLEOptions {}\n\nexport interface UT201BLEResult {\n  fahrenheit?: number;\n  celsius?: number;\n  date?: {\n    year: number;\n    month: number;\n    day: number;\n    hour: number;\n    minute: number;\n    second: number;\n  };\n  temperatureType?: string;\n}\n\nexport default class UT201BLE implements ObnizPartsBleInterface {\n  public static info(): ObnizPartsBleInfo {\n    return {\n      name: \"UT201BLE\",\n    };\n  }\n\n  public static isDevice(peripheral: BleRemotePeripheral) {\n    return peripheral.localName && peripheral.localName.startsWith(\"A&D_UT201BLE_\");\n  }\n\n  public onNotify?: (co2: number) => void;\n  public _peripheral: BleRemotePeripheral | null;\n  public ondisconnect?: (reason: any) => void;\n  public genericAccess?: BleGenericAccess;\n  public batteryService?: BleBatteryService;\n  private _timezoneOffsetMinute: number;\n\n  constructor(peripheral: BleRemotePeripheral | null, timezoneOffsetMinute: number) {\n    if (!peripheral || !UT201BLE.isDevice(peripheral)) {\n      throw new Error(\"peripheral is not UT201BLE\");\n    }\n    this._peripheral = peripheral;\n    this._timezoneOffsetMinute = timezoneOffsetMinute;\n  }\n\n  public async pairingWait(): Promise<string | null> {\n    if (!this._peripheral) {\n      throw new Error(\"UT201BLE not found\");\n    }\n    this._peripheral.ondisconnect = (reason: any) => {\n      if (typeof this.ondisconnect === \"function\") {\n        this.ondisconnect(reason);\n      }\n    };\n    let key: string | null = null;\n    await this._peripheral.connectWait({\n      pairingOption: {\n        onPairedCallback: (pairingKey) => {\n          key = pairingKey;\n        },\n      },\n    });\n\n    const { timeChar, customServiceChar } = this._getChars();\n\n    await this._writeTimeChar(this._timezoneOffsetMinute);\n\n    await customServiceChar.writeWait([2, 1, 3]); // disconnect req\n    return key;\n  }\n\n  public async getDataWait(pairingKeys?: string): Promise<UT201BLEResult[]> {\n    if (!this._peripheral) {\n      throw new Error(\"UT201BLE not found\");\n    }\n\n    await this._peripheral.connectWait({\n      pairingOption: {\n        keys: pairingKeys,\n      },\n    });\n\n    return await new Promise(async (resolve, reject) => {\n      if (!this._peripheral) {\n        throw new Error(\"UT201BLE not found\");\n      }\n      const results: UT201BLEResult[] = [];\n      const { temperatureMeasurementChar, timeChar, customServiceChar } = this._getChars();\n\n      await customServiceChar.writeWait([2, 0, 0xe1]); // send all data\n\n      await this._writeTimeChar(this._timezoneOffsetMinute);\n\n      temperatureMeasurementChar.registerNotifyWait((data: number[]) => {\n        results.push(this._analyzeData(data));\n      });\n\n      this._peripheral.ondisconnect = (reason: any) => {\n        resolve(results);\n      };\n    });\n  }\n\n  private _readFloatLE(buffer: Buffer, index: number) {\n    const data = buffer.readUInt32LE(index);\n    let mantissa = data & 0x00ffffff;\n    if ((mantissa & 0x00800000) > 0) {\n      mantissa = -1 * (~(mantissa - 0x01) & 0x00ffffff);\n    }\n    const exponential = data >> 24;\n    return mantissa * Math.pow(10, exponential);\n  }\n\n  private _analyzeData(data: number[]): UT201BLEResult {\n    const buf = Buffer.from(data);\n    const flags = buf.readUInt8(0);\n\n    let index = 1;\n    const result: UT201BLEResult = {};\n    if (flags & 0x01) {\n      // Fahrenheit\n      result.fahrenheit = this._readFloatLE(buf, index);\n      index += 4;\n    } else {\n      // Celsius\n      result.celsius = this._readFloatLE(buf, index);\n      index += 4;\n    }\n    if (flags & 0x02) {\n      // Time Stamp field present\n      result.date = {\n        year: buf.readUInt16LE(index),\n        month: buf.readUInt8(index + 2),\n        day: buf.readUInt8(index + 3),\n        hour: buf.readUInt8(index + 4),\n        minute: buf.readUInt8(index + 5),\n        second: buf.readUInt8(index + 6),\n      };\n      index += 7;\n    }\n    if (flags & 0x04) {\n      const types = [\n        \"unknown\",\n        \"Armpit\",\n        \"Body\",\n        \"Ear\",\n        \"Finger\",\n        \"Gastro-intestinal Tract\",\n        \"Mouth\",\n        \"Rectum\",\n        \"Toe\",\n        \"Tympanum\",\n      ];\n      const value = buf.readUInt8(index);\n      index++;\n      result.temperatureType = types[value] || \"unknown\";\n    }\n\n    return result;\n  }\n\n  private _getChars() {\n    if (!this._peripheral) {\n      throw new Error(\"UT201BLE not found\");\n    }\n\n    const temperatureMeasurementChar: BleRemoteCharacteristic = this._peripheral\n      .getService(\"1809\")!\n      .getCharacteristic(\"2A1C\")!;\n    const timeChar = this._peripheral.getService(\"1809\")!.getCharacteristic(\"2A08\")!;\n    const customServiceChar = this._peripheral\n      .getService(\"233bf0005a341b6d975c000d5690abe4\")!\n      .getCharacteristic(\"233bf0015a341b6d975c000d5690abe4\")!;\n\n    return {\n      temperatureMeasurementChar,\n      timeChar,\n      customServiceChar,\n    };\n  }\n\n  private async _writeTimeChar(timeOffsetMinute: number) {\n    const { timeChar } = this._getChars();\n\n    const date = new Date();\n    date.setTime(Date.now() + 1000 * 60 * timeOffsetMinute);\n    const buf = Buffer.alloc(7);\n    buf.writeUInt16LE(date.getUTCFullYear(), 0);\n    buf.writeUInt8(date.getUTCMonth() + 1, 2);\n    buf.writeUInt8(date.getUTCDate(), 3);\n    buf.writeUInt8(date.getUTCHours(), 4);\n    buf.writeUInt8(date.getUTCMinutes(), 5);\n    buf.writeUInt8(date.getUTCSeconds(), 6);\n    const arr = Array.from(buf);\n    await timeChar.writeWait(arr);\n  }\n}\n"]}