{"version":3,"sources":["../src/parts/Ble/PLS_01BT/index.ts"],"names":[],"mappings":";AAAA;;;GAGG;;AAeH,MAAqB,QAAQ;IA4B3B,YAAY,UAAsC;QAd3C,SAAI,GAAa,EAAE,CAAC;QACpB,iBAAY,GAAa,EAAE,CAAC;QAE5B,cAAS,GAA8C,IAAI,CAAC;QAG3D,WAAM,GAAG;YACf,OAAO,EAAE,sCAAsC;YAC/C,MAAM,EAAE,sCAAsC;SAC/C,CAAC;QACM,gBAAW,GAA+B,IAAI,CAAC;QAC/C,sBAAiB,GAAmC,IAAI,CAAC;QACzD,sBAAiB,GAAmC,IAAI,CAAC;QAG/D,IAAI,UAAU,IAAI,CAAC,QAAQ,CAAC,QAAQ,CAAC,UAAU,CAAC,EAAE;YAChD,MAAM,IAAI,KAAK,CAAC,4BAA4B,CAAC,CAAC;SAC/C;QACD,IAAI,CAAC,WAAW,GAAG,UAAU,CAAC;IAChC,CAAC;IAhCM,MAAM,CAAC,IAAI;QAChB,OAAO;YACL,IAAI,EAAE,UAAU;SACjB,CAAC;IACJ,CAAC;IAEM,MAAM,CAAC,QAAQ,CAAC,UAA+B;QACpD,IAAI,UAAU,CAAC,SAAS,IAAI,UAAU,CAAC,SAAS,CAAC,UAAU,CAAC,aAAa,CAAC,EAAE;YAC1E,OAAO,IAAI,CAAC;SACb;QACD,OAAO,KAAK,CAAC;IACf,CAAC;IAuBD,aAAa;IACN,KAAK,CAAC,KAAY,IAAS,CAAC;IAE5B,KAAK,CAAC,WAAW;QACtB,IAAI,CAAC,IAAI,CAAC,WAAW,EAAE;YACrB,MAAM,IAAI,KAAK,CAAC,uBAAuB,CAAC,CAAC;SAC1C;QACD,IAAI,CAAC,WAAW,CAAC,YAAY,GAAG,CAAC,MAAM,EAAE,EAAE;YACzC,IAAI,IAAI,CAAC,YAAY,EAAE;gBACrB,IAAI,CAAC,YAAY,CAAC,MAAM,CAAC,CAAC;aAC3B;QACH,CAAC,CAAC;QACF,MAAM,IAAI,CAAC,WAAW,CAAC,WAAW,EAAE,CAAC;QACrC,IAAI,CAAC,iBAAiB,GAAG,IAAI,CAAC,WAAW,CAAC,UAAU,CAAC,IAAI,CAAC,MAAM,CAAC,OAAO,CAAE,CAAC,iBAAiB,CAAC,IAAI,CAAC,MAAM,CAAC,MAAM,CAAC,CAAC;QAEjH,IAAI,CAAC,IAAI,CAAC,iBAAiB,EAAE;YAC3B,MAAM,IAAI,KAAK,CAAC,wBAAwB,CAAC,CAAC;SAC3C;QAED,MAAM,IAAI,CAAC,iBAAiB,CAAC,kBAAkB,CAAC,CAAC,IAAI,EAAE,EAAE;YACvD,IAAI,IAAI,CAAC,MAAM,KAAK,CAAC,IAAI,IAAI,CAAC,CAAC,CAAC,KAAK,IAAI,EAAE;gBACzC,IAAI,IAAI,CAAC,CAAC,CAAC,KAAK,GAAG,IAAI,IAAI,CAAC,CAAC,CAAC,KAAK,GAAG,EAAE;oBACtC,MAAM,SAAS,GAAG,IAAI,CAAC,CAAC,CAAC,CAAC;oBAC1B,MAAM,gBAAgB,GAAG,IAAI,CAAC,CAAC,CAAC,CAAC;oBACjC,MAAM,cAAc,GAAG,IAAI,CAAC,CAAC,CAAC,CAAC;oBAC/B,IAAI,IAAI,CAAC,SAAS,EAAE;wBAClB,IAAI,CAAC,SAAS,CAAC;4BACb,SAAS;4BACT,gBAAgB;4BAChB,cAAc;yBACf,CAAC,CAAC;qBACJ;iBACF;aACF;QACH,CAAC,CAAC,CAAC;IACL,CAAC;IAEM,KAAK,CAAC,cAAc;QACzB,IAAI,CAAC,IAAI,CAAC,WAAW,EAAE;YACrB,MAAM,IAAI,KAAK,CAAC,uBAAuB,CAAC,CAAC;SAC1C;QACD,MAAM,IAAI,CAAC,WAAW,CAAC,cAAc,EAAE,CAAC;IAC1C,CAAC;CACF;AA9ED,2BA8EC","file":"index.js","sourcesContent":["/**\n * @packageDocumentation\n * @module Parts.PLS_01BT\n */\n\nimport Obniz from \"../../../obniz\";\nimport BleRemoteCharacteristic from \"../../../obniz/libs/embeds/bleHci/bleRemoteCharacteristic\";\nimport BleRemotePeripheral from \"../../../obniz/libs/embeds/bleHci/bleRemotePeripheral\";\nimport ObnizPartsInterface, { ObnizPartsInfo } from \"../../../obniz/ObnizPartsInterface\";\n\nexport interface PLS_01BTResult {\n  pulseRate: number;\n  bloodOxygenLevel: number;\n  perfusionIndex: number;\n}\n\nexport interface PLS_01BTOptions {}\n\nexport default class PLS_01BT implements ObnizPartsInterface {\n  public static info(): ObnizPartsInfo {\n    return {\n      name: \"PLS_01BT\",\n    };\n  }\n\n  public static isDevice(peripheral: BleRemotePeripheral) {\n    if (peripheral.localName && peripheral.localName.startsWith(\"My Oximeter\")) {\n      return true;\n    }\n    return false;\n  }\n\n  public keys: string[] = [];\n  public requiredKeys: string[] = [];\n  public params: any;\n  public onmesured: ((result: PLS_01BTResult) => void) | null = null;\n  public ondisconnect?: (reason: any) => void;\n\n  private _uuids = {\n    service: \"CDEACB80-5235-4C07-8846-93A37EE6B86D\",\n    rxChar: \"CDEACB81-5235-4C07-8846-93A37EE6B86D\",\n  };\n  private _peripheral: BleRemotePeripheral | null = null;\n  private _rxCharacteristic: BleRemoteCharacteristic | null = null;\n  private _txCharacteristic: BleRemoteCharacteristic | null = null;\n\n  constructor(peripheral: BleRemotePeripheral | null) {\n    if (peripheral && !PLS_01BT.isDevice(peripheral)) {\n      throw new Error(\"peripheral is not PLS_01BT\");\n    }\n    this._peripheral = peripheral;\n  }\n\n  // @ts-ignore\n  public wired(obniz: Obniz): void {}\n\n  public async connectWait() {\n    if (!this._peripheral) {\n      throw new Error(\"PLS_01BT is not find.\");\n    }\n    this._peripheral.ondisconnect = (reason) => {\n      if (this.ondisconnect) {\n        this.ondisconnect(reason);\n      }\n    };\n    await this._peripheral.connectWait();\n    this._rxCharacteristic = this._peripheral.getService(this._uuids.service)!.getCharacteristic(this._uuids.rxChar);\n\n    if (!this._rxCharacteristic) {\n      throw new Error(\"device is not PLS_01BT\");\n    }\n\n    await this._rxCharacteristic.registerNotifyWait((data) => {\n      if (data.length === 4 && data[0] === 0x81) {\n        if (data[1] !== 255 && data[2] !== 177) {\n          const pulseRate = data[1];\n          const bloodOxygenLevel = data[2];\n          const perfusionIndex = data[3];\n          if (this.onmesured) {\n            this.onmesured({\n              pulseRate,\n              bloodOxygenLevel,\n              perfusionIndex,\n            });\n          }\n        }\n      }\n    });\n  }\n\n  public async disconnectWait() {\n    if (!this._peripheral) {\n      throw new Error(\"PLS_01BT is not find.\");\n    }\n    await this._peripheral.disconnectWait();\n  }\n}\n"]}