{"version":3,"sources":["../src/parts/Ble/cir415a/index.ts"],"names":[],"mappings":"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","file":"index.js","sourcesContent":["/**\n * @packageDocumentation\n * @module Parts.cir415a\n */\n\nimport crypto from \"crypto\";\nimport BleRemoteCharacteristic from \"../../../obniz/libs/embeds/bleHci/bleRemoteCharacteristic\";\nimport BleRemotePeripheral from \"../../../obniz/libs/embeds/bleHci/bleRemotePeripheral\";\nimport ObnizPartsBleInterface, { ObnizPartsBleInfo } from \"../../../obniz/ObnizPartsBleInterface\";\n\nexport interface cir415aOptions {}\n\nexport default class cir415a implements ObnizPartsBleInterface {\n  public static info(): ObnizPartsBleInfo {\n    return {\n      name: \"cir415a\",\n    };\n  }\n\n  public static isDevice(peripheral: BleRemotePeripheral): boolean {\n    return peripheral.localName?.indexOf(\"ACR1255U-J1-\") === 0;\n  }\n\n  public onNotify: ((data: number[]) => void) | null = null;\n  public onAuthenticated: (() => void) | null = null;\n  public onCardTouch: ((state: boolean) => void) | null = null;\n  public _peripheral: BleRemotePeripheral | null = null;\n  public ondisconnect?: (reason: any) => void;\n\n  private _authenticated: boolean = false;\n  private masterKey: number[] = [\n    0x41,\n    0x43,\n    0x52,\n    0x31,\n    0x32,\n    0x35,\n    0x35,\n    0x55,\n    0x2d,\n    0x4a,\n    0x31,\n    0x20,\n    0x41,\n    0x75,\n    0x74,\n    0x68,\n  ];\n  private sessionKey: number[] = [];\n  private randomDeviceNumber: number[] = [];\n  private randomNumber: number[] = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15];\n  private _uuids = {\n    service: \"3C4AFFF0-4783-3DE5-A983-D348718EF133\",\n    writeChar: \"3C4AFFF1-4783-3DE5-A983-D348718EF133\",\n    readChar: \"3C4AFFF2-4783-3DE5-A983-D348718EF133\",\n  };\n  private readData: number[] = [];\n  private readChar: BleRemoteCharacteristic | null = null;\n\n  constructor(peripheral: BleRemotePeripheral | null) {\n    if (peripheral && !cir415a.isDevice(peripheral)) {\n      throw new Error(\"peripheral is not cir415a\");\n    }\n    this._peripheral = peripheral;\n    this._authenticated = false;\n  }\n\n  public async connectWait() {\n    if (!this._peripheral) {\n      throw new Error(\"peripheral is not cir415a\");\n    }\n    if (!this._peripheral.connected) {\n      this._peripheral.ondisconnect = (reason: any) => {\n        if (typeof this.ondisconnect === \"function\") {\n          this.ondisconnect(reason);\n        }\n      };\n      await this._peripheral.connectWait();\n      this.randomDeviceNumber = [];\n      this.readData = [];\n    }\n    const service = this._peripheral.getService(this._uuids.service)!;\n    this.readChar = service.getCharacteristic(this._uuids.writeChar);\n    await service.getCharacteristic(this._uuids.readChar)!.registerNotifyWait(async (data: number[]) => {\n      this.readPacket(data);\n    });\n\n    await this.writeBle([0x6b, 0x00, 0x05, 0x00, 0x00, 0x00, 0x00, 0xe0, 0x00, 0x00, 0x45, 0x00], null); // auth step.1\n  }\n\n  public async disconnectWait() {\n    if (this._peripheral && this._peripheral.connected) {\n      await this._peripheral.disconnectWait();\n    }\n  }\n\n  public async write(data: number[]) {\n    if (!this._authenticated) {\n      throw new Error(\"cir415a no authenticate\");\n    }\n    if (data.length % 16 !== 0) {\n      const l = 16 - (data.length % 16);\n      for (let i = 0; i < l; i++) {\n        data.push(0xff);\n      }\n    }\n    this.writeBle(data, this.sessionKey);\n  }\n\n  public setMasterKey(key: number[]) {\n    if (key.length !== 16) {\n      throw new Error(\"setMasterKey length error\");\n    }\n    this.masterKey = key;\n  }\n\n  public async setAutoPollingWait(enable: boolean) {\n    if (!this._authenticated) {\n      throw new Error(\"cir415a no authenticate\");\n    }\n    await this.write([0x6b, 0x00, 0x05, 0x00, 0x00, 0x00, 0x00, 0xe0, 0x00, 0x00, 0x40, enable ? 0x01 : 0x00]);\n  }\n\n  public async writeADPU(data: number[]) {\n    if (!this._authenticated) {\n      throw new Error(\"cir415a no authenticate\");\n    }\n    await this.write([0x6f, (data.length & 0xff00) >> 8, data.length & 0x00ff, 0x00, 0x00, 0x00, 0x00].concat(data));\n  }\n\n  private readPacket(data: number[]) {\n    this.readData = this.readData.concat(data);\n    if (this.readData[0] !== 0x05) {\n      this.readData = [];\n    }\n    const dLength = ((this.readData[1] & 0xff) << 8) | (this.readData[2] & 0x00ff);\n\n    if (this.readData.length - 5 < dLength) {\n      // lack data length\n      return;\n    }\n    if (this.readData[dLength + 4] === 0x0a) {\n      // last packet check\n      data = this.readData.slice(0, dLength + 5);\n      this.parseBlePacket(data);\n      if (this.readData.length > dLength + 5) {\n        // more data\n        this.readData = this.readData.slice(dLength + 5);\n        this.readPacket([]);\n      } else {\n        // delete data\n        this.readData = [];\n      }\n    } else {\n      // console.log(\"error data\");\n      this.readData = [];\n    }\n  }\n\n  private encrypt(data: number[], key: number[]): number[] {\n    const c = crypto.createCipheriv(\"aes-128-cbc\", Buffer.from(key), new Uint8Array(16));\n    c.setAutoPadding(false);\n\n    let t = c.update(Buffer.from(data), undefined, \"hex\");\n    t += c.final(\"hex\");\n    return Array.from(Buffer.from(t, \"hex\"));\n  }\n\n  private decrypt(data: number[], key: number[]): number[] {\n    const dec = crypto.createDecipheriv(\"aes-128-cbc\", Buffer.from(key), new Uint8Array(16));\n    dec.setAutoPadding(false);\n    let t = dec.update(Buffer.from(data), \"binary\", \"binary\");\n    t += dec.final(\"binary\");\n    const d = Array.from(Buffer.from(t));\n    const list: number[] = [];\n    for (let i = 0; i < d.length; i++) {\n      list.push(d[i] >= 194 ? ((d[i] & 0b00000011) << 6) | (d[++i] & 0b00111111) : d[i]);\n    }\n    return list;\n  }\n\n  private parseBlePacket(data: number[]) {\n    switch (data[3]) {\n      case 0x83:\n        if (!this._authenticated) {\n          if (this.randomDeviceNumber.length <= 0) {\n            // auth step.2\n            let randomDevice: number[] = [];\n            for (let i = 15; i < data.length - 2; i++) {\n              randomDevice.push(data[i]);\n            }\n            this.randomDeviceNumber = randomDevice;\n            randomDevice = this.decrypt(randomDevice, this.masterKey);\n            this.sessionKey = randomDevice.slice(0, 8).concat(this.randomNumber.slice(0, 8));\n            randomDevice = this.decrypt(this.randomNumber.concat(randomDevice), this.masterKey);\n            let sendPacket = [0x6b, 0x00, 0x25, 0x00, 0x00, 0x00, 0x00, 0xe0, 0x00, 0x00, 0x46, 0x00];\n            sendPacket = sendPacket.concat(randomDevice);\n            this.writeBle(sendPacket, null);\n            return;\n            // auth step.3\n          } else {\n            // auth step.4\n            let randomDevice: number[] = [];\n            for (let i = 15; i < data.length - 2; i++) {\n              randomDevice.push(data[i]);\n            }\n            randomDevice = this.decrypt(randomDevice, this.masterKey);\n            if (this.arrayMatch(this.randomNumber, randomDevice)) {\n              this._authenticated = true;\n              if (this.onAuthenticated) {\n                this.onAuthenticated();\n              }\n            }\n            return;\n          }\n        }\n        break;\n    }\n    const d = this.decrypt(data.slice(3, data.length - 2), this.sessionKey);\n    const dLen = (((d[1] & 0xff) << 8) | (d[2] & 0x00ff)) + 7; // command Data Form 7 length\n    const dt = d.slice(0, dLen);\n    switch (dt[0]) {\n      case 0x50:\n        if (this.onCardTouch) {\n          this.onCardTouch(dt[5] === 3);\n        }\n        break;\n    }\n    if (this.onNotify) {\n      this.onNotify(dt);\n    }\n  }\n\n  private async writeBle(data: number[], key: number[] | null) {\n    let packet = [0x05, (data.length & 0xff00) >> 8, data.length & 0x00ff];\n    let checksum = 0;\n    for (let i = 0; i < data.length; i++) {\n      if (i === 6) {\n        continue; // check sum\n      }\n      checksum = (checksum ^ data[i]) & 0xff;\n    }\n    data[6] = checksum;\n    if (key !== null) {\n      data = this.encrypt(data, key);\n    }\n    packet = packet.concat(data);\n    checksum = 0;\n    for (let i = 1; i < packet.length; i++) {\n      checksum = (checksum ^ packet[i]) & 0xff;\n    }\n    packet.push(checksum);\n    packet.push(0x0a);\n    for (let i = 0; i < packet.length / 20; i++) {\n      const d = packet.slice(i * 20, (i + 1) * 20);\n      await this.readChar!.writeWait(d);\n    }\n  }\n\n  private arrayMatch(array1: number[], array2: number[]): boolean {\n    if (array1.length === array2.length) {\n      for (let i = 0; i < array1.length; i++) {\n        if (array1[i] === array2[i]) {\n          break;\n        }\n        return false;\n      }\n      return true;\n    }\n    return false;\n  }\n\n  // private printHex(data: number[], tag: string) {\n  //   let s = \"\";\n  //   for (let i = 0; i < data.length; i++) {\n  //     s += \"0x\" + (\"0\" + data[i].toString(16)).slice(-2) + \", \";\n  //   }\n  //   console.log(`${tag} : ${s}`);\n  // }\n}\n"]}